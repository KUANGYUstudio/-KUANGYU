<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>光聿功率課登記</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    h1 {
      font-size: 24px;
    }
    .info {
      font-size: 14px;
      margin-bottom: 20px;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 20px;
    }
    .day {
      padding: 12px 0;
      border-radius: 8px;
      background: #eee;
      color: #ccc;
      cursor: not-allowed;
    }
    .day.open {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .day:hover {
      background-color: #e0f7fa;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>光聿功率課登記</h1>
  <div class="info">
    功率早班：週三 6:30 – 8:00<br />
    功率晚班：週二、週四 19:30 – 21:00（線上功率同步）
  </div>
  <div id="calendar" class="calendar"></div>
  <p id="result"></p>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDcma_niKFZiKmoWVzeEdixP4nege-j7S6P4kBAiT89L1YJL_qdtGguGuWje_bPKgpjw/exec";

    function formatDate(date) {
      return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
    }

    async function loadCalendar() {
      const calendarDiv = document.getElementById("calendar");
      calendarDiv.innerHTML = "載入中...";

      try {
        const resName = await fetch(`${SCRIPT_URL}?mode=getName`);
        const nameData = await resName.json();
        const name = nameData.name;

        const res = await fetch(`${SCRIPT_URL}?mode=dates`);
        const data = await res.json();
        const open = data.open;
        const close = data.close;

        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

        calendarDiv.innerHTML = "";
        for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
          const formatted = formatDate(d);
          const div = document.createElement("div");
          div.className = "day";
          div.innerText = d.getDate();

          if (open.includes(formatted)) {
            div.classList.add("open");
            div.onclick = async () => {
              const response = await fetch(`${SCRIPT_URL}?name=${encodeURIComponent(name)}&date=${encodeURIComponent(formatted)}`);
              const result = await response.json();
              document.getElementById("result").innerText = result.success
                ? `✅ ${formatted} 登記成功！`
                : `⚠️ ${result.message || '你已經登記過囉！'}`;
            };
          }

          calendarDiv.appendChild(div);
        }
      } catch (error) {
        console.error("日曆載入錯誤：", error);
        calendarDiv.innerText = "⚠️ 日期無法載入，請稍後再試。";
      }
    }

    window.onload = loadCalendar;
  </script>
</body>
</html>

