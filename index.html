<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…‰è¿åŠŸç‡èª²ç™»è¨˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ğŸ”§ CSS æ¨£å¼å€ï¼šè¨­å®šæ•´é«”ç‰ˆé¢èˆ‡æ—¥æ›†å¤–è§€ -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1em;
      background: #f9f9f9;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 0.2em;
    }
    .sub-info {
      text-align: center;
      font-size: 15px;
      color: #555;
      margin-bottom: 1.5em;
      line-height: 1.6;
    }
    .month-title {
      text-align: center;
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 0.5em;
      color: #333;
    }
    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday-header {
      font-weight: bold;
      text-align: center;
      padding: 0.5em 0;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 2em;
    }
    .day {
      aspect-ratio: 1/1;
      background: #fff;
      border-radius: 6px;
      text-align: center;
      padding: 0.3em 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      font-size: 18px;
      cursor: pointer;
      white-space: pre-line;
    }
    .inactive {
      color: #ccc;
      background: #f0f0f0;
      cursor: default;
    }
    .available {
      background: #e0faff;
      font-weight: bold;
    }
    .signed {
      background: #d0f5c8 !important;
      border: 2px solid #45a049;
    }
    #message {
      margin-top: 1em;
      text-align: center;
      font-weight: bold;
    }
    #name-box {
      margin-bottom: 1em;
      text-align: center;
    }
    #name {
      font-size: 16px;
      padding: 6px 12px;
      width: 90%;
      max-width: 300px;
      margin-top: 4px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>å…‰è¿åŠŸç‡èª²ç™»è¨˜</h1>
    <div class="sub-info">
      åŠŸç‡æ—©ç­ï¼šé€±ä¸‰ 6:30ï¼8:00<br />
      åŠŸç‡æ™šç­ï¼šé€±äºŒã€é€±å›› 19:30ï¼21:00ï¼ˆç·šä¸ŠåŠŸç‡åŒæ­¥ï¼‰
    </div>

    <!-- ğŸ”¹ é¡¯ç¤ºç›®å‰ä½¿ç”¨è€…å§“å -->
    <div id="name-box">
      <label>å§“åï¼š</label><br/>
      <input type="text" id="name" readonly />
    </div>

    <!-- ğŸ”¹ æ—¥æ›†èˆ‡è¨Šæ¯é¡¯ç¤ºå€ -->
    <div id="calendar-container"></div>
    <div id="message"></div>
  </div>

  <script>
    // âœ… æ›´æ›ç‚ºä½ éƒ¨ç½²å¥½çš„ Google Apps Script ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPaVBQPB5_WBKZWecsSNpxsvx7JnCPnGZOLMlHdy8XhQC3b_H0GhLbtHRa03li84NK/exec";

    // ğŸ”§ æ—¥æœŸæ ¼å¼è™•ç†ï¼šè½‰ç‚º yyyy/mm/dd
    function formatDate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}/${mm}/${dd}`;
    }

    // ğŸ“† é¡¯ç¤ºæœˆä»½æ–‡å­—ï¼Œä¾‹å¦‚ 2025å¹´6æœˆ
    function getMonthText(year, month) {
      return `${year}å¹´${month + 1}æœˆ`;
    }

    // ğŸ”„ ä¸»åŠŸèƒ½ï¼šè¼‰å…¥å ±åè³‡æ–™èˆ‡ç”¢ç”Ÿæ—¥æ›†
    async function loadDates() {
      const container = document.getElementById("calendar-container");
      const message = document.getElementById("message");

      container.innerHTML = "è¼‰å…¥ä¸­...";

      try {
        // ğŸ”½ åŒæ™‚å–å¾—é–‹æ”¾æ—¥æœŸã€æ¯æ—¥æœŸå ±åäººæ•¸ã€ä½¿ç”¨è€…å§“å
        const [datesRes, countRes, nameRes] = await Promise.all([
          fetch(`${SCRIPT_URL}?mode=dates`),
          fetch(`${SCRIPT_URL}?mode=count`),
          fetch(`${SCRIPT_URL}?mode=getName`)
        ]);

        const dateData = await datesRes.json();  // { open: [...], close: [...] }
        const countData = await countRes.json(); // { "2025/06/25": 3, signed: { "2025/06/25": ["ç‹å°æ˜", ...] } }
        const nameData = await nameRes.json();   // { name: "ç‹å°æ˜" }

        const userName = nameData.name;
        document.getElementById("name").value = userName || "ï¼ˆè¼‰å…¥å¤±æ•—ï¼‰";

        const available = new Set(dateData.open);
        const signedMap = countData.signed || {};

        // â¤ æ±ºå®šæ—¥æ›†é¡¯ç¤ºå€é–“
        const firstOpen = new Date(dateData.open[0]);
        const lastOpen = new Date(dateData.open[dateData.open.length - 1]);

        container.innerHTML = "";

        // ğŸ” æ¯æœˆä¸€å€‹æœˆæ›†å€å¡Š
        for (let y = firstOpen.getFullYear(); y <= lastOpen.getFullYear(); y++) {
          const startMonth = y === firstOpen.getFullYear() ? firstOpen.getMonth() : 0;
          const endMonth = y === lastOpen.getFullYear() ? lastOpen.getMonth() : 11;

          for (let m = startMonth; m <= endMonth; m++) {
            const firstDay = new Date(y, m, 1);
            const lastDay = new Date(y, m + 1, 0);
            const startWeekday = firstDay.getDay();
            const totalDays = lastDay.getDate();

            // â¬…ï¸ æœˆä»½æ¨™é¡Œ
            const title = document.createElement("div");
            title.className = "month-title";
            title.textContent = getMonthText(y, m);

            // ğŸ“… æ˜ŸæœŸæ¨™é¡Œ
            const header = document.createElement("div");
            header.className = "calendar-header";
            ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"].forEach(day => {
              const div = document.createElement("div");
              div.className = "weekday-header";
              div.textContent = day;
              header.appendChild(div);
            });

            // ğŸ”² æ—¥æ›†æ ¼å­
            const grid = document.createElement("div");
            grid.className = "calendar-grid";

            // â¬› è£œç©ºæ ¼ï¼ˆé¦–æ—¥ä¸æ˜¯æ˜ŸæœŸæ—¥æ™‚ï¼‰
            for (let i = 0; i < startWeekday; i++) {
              const cell = document.createElement("div");
              cell.className = "day inactive";
              grid.appendChild(cell);
            }

            // ğŸŸ¦ å»ºç«‹æ¯ä¸€æ—¥çš„æ ¼å­
            for (let d = 1; d <= totalDays; d++) {
              const current = new Date(y, m, d);
              const dateStr = formatDate(current);
              const cell = document.createElement("div");
              cell.className = "day";
              cell.textContent = d;

              if (available.has(dateStr)) {
                const signedUp = countData[dateStr] || 0;
                const remaining = 6 - signedUp;
                const alreadySigned = signedMap[dateStr]?.includes(userName);

                // âœ… å·²ç™»è¨˜é¡¯ç¤º
                if (alreadySigned) {
                  cell.classList.add("signed");
                  cell.textContent = `${d}\nå·²ç™»è¨˜`;
                }

                // ğŸš« æ»¿ç­ä¸èƒ½å ±å
                else if (remaining <= 0) {
                  cell.classList.add("inactive");
                  cell.textContent = `${d}\næ»¿ç­`;
                }

                // ğŸŸ¢ å¯ç™»è¨˜
                else {
                  cell.classList.add("available");
                  cell.textContent = `${d}\nå‰©${remaining}`;
                  cell.onclick = async () => {
                    const confirmSignup = window.confirm(`æ˜¯å¦è¦ç™»è¨˜ ${dateStr} çš„åŠŸç‡èª²ï¼Ÿ`);
                    if (!confirmSignup) return;

                    message.textContent = "è™•ç†ä¸­...";
                    try {
                      const res = await fetch(`${SCRIPT_URL}?mode=submit&date=${dateStr}`);
                      const result = await res.text();
                      message.textContent = `âœ… ${result}`;
                      alert(`âœ… ${result}`);
                      await loadDates(); // é‡æ–°è¼‰å…¥
                    } catch (e) {
                      console.error("éŒ¯èª¤ï¼š", e);
                      message.textContent = "âš ï¸ ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
                    }
                  };
                }
              } else {
                // ğŸ”’ é—œé–‰æ—¥æœŸ
                cell.classList.add("inactive");
              }

              grid.appendChild(cell);
            }

            container.appendChild(title);
            container.appendChild(header);
            container.appendChild(grid);
          }
        }

      } catch (e) {
        container.innerHTML = `<div style="color: red;">âš ï¸ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>`;
        console.error(e);
      }
    }

    loadDates(); // é é¢è¼‰å…¥å¾ŒåŸ·è¡Œ
  </script>
</body>
</html>



