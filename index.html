<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…‰è¿åŠŸç‡èª²ç™»è¨˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1em;
      background: #f9f9f9;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 0.2em;
    }
    .sub-info {
      text-align: center;
      font-size: 15px;
      color: #555;
      margin-bottom: 1.5em;
      line-height: 1.6;
    }
    .month-title {
      text-align: center;
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 0.5em;
      color: #333;
    }
    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday-header {
      font-weight: bold;
      text-align: center;
      padding: 0.5em 0;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 2em;
    }
    .day {
      aspect-ratio: 1/1;
      background: #fff;
      border-radius: 6px;
      text-align: center;
      padding: 0.3em 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      font-size: 18px;
      cursor: pointer;
      white-space: pre-line;
    }
    .inactive {
      color: #ccc;
      background: #f0f0f0;
      cursor: default;
    }
    .available {
      background: #e0faff;
      font-weight: bold;
    }
    .signed {
      background: #d0f5c8 !important;
      border: 2px solid #45a049;
    }
    #message {
      margin-top: 1em;
      text-align: center;
      font-weight: bold;
    }
    #name-box {
      margin-bottom: 1em;
      text-align: center;
    }
    #name {
      font-size: 16px;
      padding: 6px 12px;
      width: 90%;
      max-width: 300px;
      margin-top: 4px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>å…‰è¿åŠŸç‡èª²ç™»è¨˜</h1>
    <div class="sub-info">
      åŠŸç‡æ—©ç­ï¼šé€±ä¸‰ 6:30ï¼8:00<br />
      åŠŸç‡æ™šç­ï¼šé€±äºŒã€é€±å›› 19:30ï¼21:00ï¼ˆç·šä¸ŠåŠŸç‡åŒæ­¥ï¼‰
    </div>

    <!-- ğŸ”¹ é¡¯ç¤ºç›®å‰ä½¿ç”¨è€…å§“å -->
    <div id="name-box">
      <label>å§“åï¼š</label><br/>
      <input type="text" id="name" readonly />
    </div>

    <div id="calendar-container"></div>
    <div id="message"></div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzhix32u2eiOr7WtkNI7hSFgQTF8TM05vrj5-bNWhIplFlI6eUakA4B__0nJkPUJdY/exec"; // æ›¿æ›ç‚ºä½ è‡ªå·±çš„ Apps Script ç¶²å€

    function formatDate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}/${mm}/${dd}`;
    }

    function getMonthText(year, month) {
      return `${year}å¹´${month + 1}æœˆ`;
    }

    async function loadDates() {
      const container = document.getElementById("calendar-container");
      const message = document.getElementById("message");
      const nameInput = document.getElementById("name");

      container.innerHTML = "è¼‰å…¥ä¸­...";
      try {
        const [datesRes, countRes, nameRes] = await Promise.all([
          fetch(`${SCRIPT_URL}?mode=dates`),
          fetch(`${SCRIPT_URL}?mode=count`),
          fetch(`${SCRIPT_URL}?mode=getName`)
        ]);

        const dateData = await datesRes.json();
        const countData = await countRes.json();
        const nameData = await nameRes.json();

        const userName = nameData.name || "ï¼ˆæœªç™»å…¥ï¼‰";
        nameInput.value = userName;

        const available = new Set(dateData.open);
        const signedMap = countData.signed || {};
        const firstOpen = new Date(dateData.open[0]);
        const lastOpen = new Date(dateData.open[dateData.open.length - 1]);

        container.innerHTML = "";

        for (let y = firstOpen.getFullYear(); y <= lastOpen.getFullYear(); y++) {
          const startMonth = y === firstOpen.getFullYear() ? firstOpen.getMonth() : 0;
          const endMonth = y === lastOpen.getFullYear() ? lastOpen.getMonth() : 11;

          for (let m = startMonth; m <= endMonth; m++) {
            const firstDay = new Date(y, m, 1);
            const lastDay = new Date(y, m + 1, 0);
            const startWeekday = firstDay.getDay();
            const totalDays = lastDay.getDate();

            const title = document.createElement("div");
            title.className = "month-title";
            title.textContent = getMonthText(y, m);

            const header = document.createElement("div");
            header.className = "calendar-header";
            ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"].forEach(day => {
              const div = document.createElement("div");
              div.className = "weekday-header";
              div.textContent = day;
              header.appendChild(div);
            });

            const grid = document.createElement("div");
            grid.className = "calendar-grid";

            for (let i = 0; i < startWeekday; i++) {
              const cell = document.createElement("div");
              cell.className = "day inactive";
              grid.appendChild(cell);
            }

            for (let d = 1; d <= totalDays; d++) {
              const current = new Date(y, m, d);
              const dateStr = formatDate(current);
              const cell = document.createElement("div");
              cell.className = "day";
              cell.textContent = d;

              if (available.has(dateStr)) {
                const signedUp = countData[dateStr] || 0;
                const remaining = 6 - signedUp;
                const alreadySigned = signedMap[dateStr]?.includes(userName);

                if (alreadySigned) {
                  cell.classList.add("signed");
                  cell.textContent = `${d}\nå·²ç™»è¨˜`;
                } else if (remaining <= 0) {
                  cell.classList.add("inactive");
                  cell.textContent = `${d}\næ»¿ç­`;
                } else {
                  cell.classList.add("available");
                  cell.textContent = `${d}\n${remaining}äºº`;
                  cell.onclick = async () => {
                    const confirmSignup = window.confirm(`æ˜¯å¦è¦ç™»è¨˜ ${dateStr} çš„åŠŸç‡èª²ï¼Ÿ`);
                    if (!confirmSignup) return;

                    message.textContent = "è™•ç†ä¸­...";
                    try {
                      const res = await fetch(`${SCRIPT_URL}?mode=submit&date=${dateStr}`);
                      const result = await res.text();
                      message.textContent = result;
                      alert(result);
                      await loadDates(); // é‡æ–°åˆ·æ–°ç•«é¢
                    } catch (e) {
                      console.error("éŒ¯èª¤ï¼š", e);
                      message.textContent = "âš ï¸ ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
                    }
                  };
                }
              } else {
                cell.classList.add("inactive");
              }

              grid.appendChild(cell);
            }

            container.appendChild(title);
            container.appendChild(header);
            container.appendChild(grid);
          }
        }

      } catch (e) {
        container.innerHTML = `<div style="color: red;">âš ï¸ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>`;
        console.error(e);
      }
    }

    loadDates();
  </script>
</body>
</html>

