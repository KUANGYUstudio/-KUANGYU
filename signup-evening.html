<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æ™šç­åŠŸç‡èª²</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body {
font-family: Arial, sans-serif;
background: #ffffff;
margin: 0;
padding: 0;
}
.container {
max-width: 1000px;
margin: 0 auto;
padding: 0.5em;
box-sizing: border-box;
text-align: center;
}
h1 {
font-size: 36px;
margin: 0.5em 0 0.2em;
}
.info {
font-size: 24px;
color: #666;
margin-bottom: 1.5em;
}
.month-title {
font-weight: bold;
font-size: 32px;
margin: 2em 0 0.8em;
}
.calendar-header,
.calendar-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 6px;
padding: 0 4px;
box-sizing: border-box;
}
.weekday-header {
font-weight: bold;
font-size: 24px;
text-align: center;
color: #888;
padding-bottom: 6px;
}
.day {
aspect-ratio: 1;
font-size: 25px;
display: flex;
align-items: center;
justify-content: center;
border-radius: 8px;
background-color: #eeeeee;
color: #aaa;
cursor: default;
}
.day.available {
background-color: #d1ecf1;
color: #000;
cursor: pointer;
border: 1px solid #17a2b8;
box-sizing: border-box;
}
.day.selected {
background-color: #17a2b8;
font-weight: bold;
color: #fff;
}
/* ğŸ†• å·²å ±åçš„æ¨£å¼ï¼ˆè—è‰²ç³»ï¼‰*/
.day.registered {
background-color: #5dade2;
color: #000;
cursor: not-allowed;
border: 2px solid #1976d2;
opacity: 0.7;
}
#submit-btn {
margin: 2em auto;
padding: 16px 32px;
font-size: 22px;
background: #17a2b8;
color: #fff;
border: none;
border-radius: 8px;
cursor: pointer;
max-width: 60%;
display: block;
}
#message {
font-size: 16px;
margin-top: 1em;
font-weight: bold;
}
@media (max-width: 750px) {
h1 { font-size: 28px; margin-bottom: 0.4em; }
.info { font-size: 18px; margin-bottom: 1em; }
.month-title { font-size: 24px; margin: 1.5em 0 0.6em; }
.container { padding: 0.5em; }
.calendar-header,
.calendar-grid { gap: 4px; padding: 0 6px; }
.weekday-header { font-size: 16px; padding-bottom: 3px; }
.day { font-size: 18px; padding: 6px 3px; }
#submit-btn { font-size: 18px; padding: 12px 22px; }
}
</style>
</head>
<body>
<div class="container">
<h1>æ™šç­åŠŸç‡èª²</h1>
<div class="info">æ¯é€±äºŒ / é€±å›› 19:30ï½21:00</div>
<div id="calendar"></div>
<button id="submit-btn">é€å‡ºå ±å</button>
<div id="message"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvyneeBpPV3ayC0DPZGIv2sv58wr1_ORhxChBMVeyYpjHOGkL3iIQlW9HayPyVi6DT/exec";

const selectedDates = new Set();
let myRegisteredDates = new Set();

function getParam(key) { 
return new URLSearchParams(window.location.search).get(key) || ''; 
}

const lineId = getParam('lineId');
const name = getParam('name');

async function loadAvailableDates() {
try {
const res = await fetch(`${SCRIPT_URL}?mode=dates`);
const data = await res.json();
return data.open || [];
} catch (error) {
console.error('è¼‰å…¥æ—¥æœŸéŒ¯èª¤:', error);
return [];
}
}

async function loadMyRegisteredDates() {
try {
const res = await fetch(`${SCRIPT_URL}?mode=mySignups&lineId=${encodeURIComponent(lineId)}&courseType=evening`);
const data = await res.json();
return new Set(data.dates || []);
} catch (error) {
console.error('è¼‰å…¥å·²å ±åæ—¥æœŸéŒ¯èª¤:', error);
return new Set();
}
}

async function renderCalendar() {
const calendarDiv = document.getElementById('calendar');
calendarDiv.innerHTML = 'è¼‰å…¥ä¸­...';

const availableDates = await loadAvailableDates();
myRegisteredDates = await loadMyRegisteredDates();

calendarDiv.innerHTML = '';

const availableSet = new Set(availableDates);

if (!availableDates.length) {
calendarDiv.innerHTML = '<div style="color:red;">âš ï¸ ç„¡å¯ç™»è¨˜æ—¥æœŸ</div>';
return;
}

const start = new Date(availableDates[0]);
const end = new Date(availableDates[availableDates.length - 1]);

for (let y = start.getFullYear(); y <= end.getFullYear(); y++) {
for (let m = 0; m < 12; m++) {
const first = new Date(y, m, 1);
const last = new Date(y, m + 1, 0);
if (last < start || first > end) continue;

const title = document.createElement('div');
title.className = 'month-title';
title.textContent = `${y}å¹´${m + 1}æœˆ`;
calendarDiv.appendChild(title);

const header = document.createElement('div');
header.className = 'calendar-header';
['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => {
const h = document.createElement('div');
h.className = 'weekday-header';
h.textContent = d;
header.appendChild(h);
});
calendarDiv.appendChild(header);

const grid = document.createElement('div');
grid.className = 'calendar-grid';

for (let i = 0; i < first.getDay(); i++) {
const cell = document.createElement('div');
cell.className = 'day';
grid.appendChild(cell);
}

for (let d = 1; d <= last.getDate(); d++) {
const dateStr = `${y}/${String(m + 1).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
const cell = document.createElement('div');
cell.className = 'day';
cell.textContent = d;

const dayOfWeek = new Date(dateStr).getDay();

if (myRegisteredDates.has(dateStr)) {
cell.classList.add('registered');
cell.textContent = d + ' âœ“';
} else if (availableSet.has(dateStr) && (dayOfWeek === 2 || dayOfWeek === 4)) {
cell.classList.add('available');
cell.onclick = () => {
if (selectedDates.has(dateStr)) {
selectedDates.delete(dateStr);
cell.classList.remove('selected');
} else {
selectedDates.add(dateStr);
cell.classList.add('selected');
}
};
}

grid.appendChild(cell);
}
calendarDiv.appendChild(grid);
}
}
}

document.getElementById('submit-btn').addEventListener('click', async () => {
if (!selectedDates.size) {
alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');
return;
}

const msg = document.getElementById('message');
msg.textContent = 'é€å‡ºä¸­...';

try {
for (const date of selectedDates) {
await fetch(`${SCRIPT_URL}?mode=submit&date=${encodeURIComponent(date)}&courseType=evening&name=${encodeURIComponent(name)}&lineId=${encodeURIComponent(lineId)}`);
}

msg.textContent = 'âœ… ç™»è¨˜å®Œæˆ';
alert('âœ… ç™»è¨˜æˆåŠŸï¼');
selectedDates.clear();
renderCalendar();
} catch (error) {
console.error('æäº¤éŒ¯èª¤:', error);
msg.textContent = 'âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
}
});

renderCalendar();
</script>
</body>
</html>
