<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™šç­åŠŸç‡èª² - å ±åç™»è¨˜</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      text-align: center;
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
      font-size: 16px;
    }

    .error {
      text-align: center;
      padding: 40px;
      color: #e53e3e;
      font-size: 16px;
    }

    .month-container {
      margin-bottom: 40px;
    }

    .month-container h3 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 22px;
      text-align: center;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }

    .weekday-header {
      text-align: center;
      padding: 10px;
      font-weight: 600;
      color: #4a5568;
      font-size: 14px;
    }

    .date-box {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 8px;
      position: relative;
    }

    .date-box.empty {
      background: transparent;
      cursor: default;
    }

    .date-box.disabled {
      background: #f7fafc;
      color: #cbd5e0;
      cursor: not-allowed;
      border: 2px solid #e2e8f0;
    }

    .date-box.available {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border: 2px solid #2196f3;
      color: #2d3748;
    }

    .date-box.available:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(33, 150, 243, 0.3);
      border-color: #1976d2;
    }

    .date-box.selected {
      background: linear-gradient(135deg, #64b5f6 0%, #2196f3 100%);
      border: 3px solid #1976d2;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
    }

    /* ğŸ†• å·²å ±åçš„æ—¥æœŸï¼ˆè—è‰²ç³» - ä¸­ç­‰æ·±åº¦ï¼‰*/
    .date-box.registered {
      background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);
      border: 2px solid #1976d2;
      cursor: not-allowed;
      opacity: 0.8;
    }

    .date-box.registered:hover {
      transform: none;
    }

    .registered-badge {
      margin-top: 4px;
      font-size: 11px;
      color: #0d47a1;
      font-weight: 600;
    }

    .date-box.full {
      background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
      border: 2px solid #0d47a1;
      cursor: not-allowed;
    }

    .full-text {
      color: #0d47a1;
      font-weight: 600;
    }

    .date-number {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .weekday {
      font-size: 12px;
      color: #718096;
      margin-bottom: 4px;
    }

    .capacity {
      font-size: 11px;
      color: #4a5568;
      margin-top: 4px;
    }

    .submit-section {
      margin-top: 40px;
      text-align: center;
    }

    .selected-info {
      margin-bottom: 20px;
      padding: 15px;
      background: #f7fafc;
      border-radius: 10px;
      color: #2d3748;
      font-size: 16px;
    }

    .submit-btn {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: white;
      border: none;
      padding: 16px 60px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
    }

    .submit-btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      box-shadow: none;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 24px;
      }

      .calendar-grid {
        gap: 6px;
      }

      .date-number {
        font-size: 16px;
      }

      .weekday {
        font-size: 10px;
      }

      .capacity {
        font-size: 9px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ™šç­åŠŸç‡èª²</h1>
    <p class="subtitle">æ¯é€±äºŒ / é€±å›› 19:30ï½21:00</p>
    
    <div id="calendar"></div>
    
    <div class="submit-section">
      <div class="selected-info" id="selected-date">è«‹é¸æ“‡æ—¥æœŸ</div>
      <button class="submit-btn" id="submit-btn" onclick="submitSignup()" disabled>é€å‡ºå ±å</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvyneeBpPV3ayC0DPZGIv2sv58wr1_ORhxChBMVeyYpjHOGkL3iIQlW9HayPyVi6DT/exec";

    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('name') || '';
    const lineId = urlParams.get('lineId') || '';

    const calendarEl = document.getElementById('calendar');
    const submitBtn = document.getElementById('submit-btn');
    const selectedDateEl = document.getElementById('selected-date');

    let availableDates = [];
    let signupCounts = {};
    let mySignups = [];
    let selectedDate = null;

    async function loadDates() {
      try {
        calendarEl.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
        
        const datesRes = await fetch(`${SCRIPT_URL}?mode=dates`);
        const datesData = await datesRes.json();
        availableDates = datesData.open || [];
        
        const countRes = await fetch(`${SCRIPT_URL}?mode=count`);
        const countData = await countRes.json();
        signupCounts = countData;
        
        const mySignupsRes = await fetch(`${SCRIPT_URL}?mode=mySignups&lineId=${encodeURIComponent(lineId)}&courseType=evening`);
        const mySignupsData = await mySignupsRes.json();
        mySignups = mySignupsData.dates || [];
        
        if (availableDates.length === 0) {
          calendarEl.innerHTML = '<p class="error">ç›®å‰æ²’æœ‰å¯å ±åçš„æ—¥æœŸ</p>';
          return;
        }
        
        renderCalendar();
      } catch (error) {
        console.error('è¼‰å…¥æ—¥æœŸå¤±æ•—:', error);
        calendarEl.innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>';
      }
    }

    function renderCalendar() {
      const datesByMonth = {};
      
      availableDates.forEach(dateStr => {
        const [year, month] = dateStr.split('/');
        const key = `${year}/${month}`;
        if (!datesByMonth[key]) datesByMonth[key] = [];
        datesByMonth[key].push(dateStr);
      });
      
      calendarEl.innerHTML = '';
      
      Object.keys(datesByMonth).sort().forEach(monthKey => {
        const [year, month] = monthKey.split('/');
        const monthDates = datesByMonth[monthKey];
        
        const monthContainer = document.createElement('div');
        monthContainer.className = 'month-container';
        
        const monthTitle = document.createElement('h3');
        monthTitle.textContent = `${year}å¹´${month}æœˆ`;
        monthContainer.appendChild(monthTitle);
        
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        
        const firstDate = new Date(monthDates[0]);
        const firstDay = firstDate.getDay();
        const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
        
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        weekdays.forEach(day => {
          const header = document.createElement('div');
          header.className = 'weekday-header';
          header.textContent = day;
          grid.appendChild(header);
        });
        
        for (let i = 0; i < firstDay; i++) {
          const empty = document.createElement('div');
          empty.className = 'date-box empty';
          grid.appendChild(empty);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(parseInt(year), parseInt(month) - 1, day);
          const dateStr = `${year}/${month.padStart(2, '0')}/${String(day).padStart(2, '0')}`;
          const dayOfWeek = date.getDay();
          const weekday = weekdays[dayOfWeek];
          
          const dateBox = document.createElement('div');
          dateBox.className = 'date-box';
          
          const isAvailable = availableDates.includes(dateStr);
          const count = signupCounts[dateStr]?.evening || 0;
          const isFull = count >= 6;
          const isRegistered = mySignups.includes(dateStr);
          
          if (!isAvailable) {
            dateBox.classList.add('disabled');
            dateBox.innerHTML = `<div class="date-number">${day}</div>`;
          } else if (isRegistered) {
            dateBox.classList.add('registered');
            dateBox.innerHTML = `
              <div class="date-number">${day}</div>
              <div class="weekday">${weekday}</div>
              <div class="capacity">${count}/6</div>
              <div class="registered-badge">âœ“ å·²å ±å</div>
            `;
          } else if (isFull) {
            dateBox.classList.add('full');
            dateBox.innerHTML = `
              <div class="date-number">${day}</div>
              <div class="weekday">${weekday}</div>
              <div class="capacity full-text">å·²æ»¿</div>
            `;
          } else {
            dateBox.classList.add('available');
            dateBox.innerHTML = `
              <div class="date-number">${day}</div>
              <div class="weekday">${weekday}</div>
              <div class="capacity">${count}/6</div>
            `;
            dateBox.onclick = () => selectDate(dateStr, dateBox);
          }
          
          grid.appendChild(dateBox);
        }
        
        monthContainer.appendChild(grid);
        calendarEl.appendChild(monthContainer);
      });
    }

    function selectDate(dateStr, element) {
      document.querySelectorAll('.date-box').forEach(box => {
        box.classList.remove('selected');
      });
      
      element.classList.add('selected');
      selectedDate = dateStr;
      selectedDateEl.textContent = `å·²é¸æ“‡ï¼š${dateStr}`;
      submitBtn.disabled = false;
    }

    async function submitSignup() {
      if (!selectedDate) {
        alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'é€å‡ºä¸­...';
      
      try {
        const url = `${SCRIPT_URL}?mode=submit&date=${encodeURIComponent(selectedDate)}&lineId=${encodeURIComponent(lineId)}&name=${encodeURIComponent(name)}&courseType=evening`;
        const response = await fetch(url);
        const result = await response.text();
        
        if (result.includes('æˆåŠŸ')) {
          alert(result);
          location.reload();
        } else {
          alert(result);
          submitBtn.disabled = false;
          submitBtn.textContent = 'é€å‡ºå ±å';
        }
      } catch (error) {
        console.error('å ±åå¤±æ•—:', error);
        alert('å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        submitBtn.disabled = false;
        submitBtn.textContent = 'é€å‡ºå ±å';
      }
    }

    loadDates();
  </script>
</body>
</html>
