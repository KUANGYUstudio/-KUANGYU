<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åºŠå¢Šè©¦èººé ç´„ | Chrisus Sport</title>
  <style>
    /* é€™è£¡æ‰¾å›äº†æœ€ç´®å¯¦çš„æ¨£å¼å®šç¾©ï¼Œç¢ºä¿æ‰‹æ©Ÿèˆ‡é›»è…¦çœ‹éƒ½å®Œç¾ */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans TC', -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d5c4 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fefdfb;
      border-radius: 30px;
      box-shadow: 0 10px 40px rgba(139, 115, 85, 0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #e8d4b8 0%, #d9c3a8 100%);
      color: #5a4a3a;
      padding: 40px 30px;
      text-align: center;
    }

    .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }

    .location-box {
      background: rgba(255, 255, 255, 0.4);
      padding: 20px;
      border-radius: 20px;
      margin-top: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .notice-section {
      background: #fef8f0;
      padding: 30px;
      border-left: 6px solid #d4a574;
      margin: 25px;
      border-radius: 0 20px 20px 0;
    }

    .notice-section li {
      margin-bottom: 10px;
      padding-left: 25px;
      position: relative;
      list-style: none;
      color: #6b5d52;
    }

    .notice-section li::before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: #d4a574;
      font-weight: bold;
    }

    .form-section { padding: 40px; }

    .form-group { margin-bottom: 30px; }

    label, .group-title {
      display: block;
      margin-bottom: 15px;
      color: #3d2b1f;
      font-weight: 700;
      font-size: 1.25em;
    }

    .required { color: #c9705f; margin-left: 4px; }

    /* é€™è£¡åŠ å¼·äº†è¼¸å…¥æ¡†çš„è³ªæ„Ÿ */
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e8d5c4;
      border-radius: 12px;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    input:focus { border-color: #d4a574; outline: none; box-shadow: 0 0 10px rgba(212,165,116,0.2); }

    /* é¸é …æŒ‰éˆ•ä¿æŒå¯¬æ•æ˜“é»æ“Š */
    .option-card {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #fef8f0;
      border: 2px solid #e8d5c4;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    .option-card:hover { transform: translateX(5px); border-color: #d4a574; }

    .option-card input { margin-right: 15px; width: 20px; height: 20px; }

    /* æ—¥æ›†æ¨£å¼åŠ å¼· */
    .calendar-container { margin-top: 15px; }
    .month-title { text-align: center; font-weight: bold; font-size: 1.4em; color: #6b5d52; margin: 20px 0; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 10px; background: #f5ebe0; font-weight: 600; color: #c9b5a0; cursor: not-allowed; }
    .calendar-day.available { background: #fff; border: 2px solid #d4a574; color: #6b5d52; cursor: pointer; }
    .calendar-day.selected { background: #d4a574; color: white; transform: scale(1.1); }

    .submit-btn {
      width: 100%;
      padding: 20px;
      background: #d4a574;
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 1.3em;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(212, 165, 116, 0.3);
    }

    .loading-overlay { display: none; text-align: center; padding: 20px; }
    .loading-overlay.active { display: block; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>åºŠå¢Šè©¦èººé ç´„</h1>
    <p>å°ˆæ¥­é‹å‹•çœ åºŠå¢Šï¼Œç‚ºæ‚¨çš„èº«é«”å……é›»</p>
    <div class="location-box">
      <h3>ğŸ“ é ç´„é–€å¸‚</h3>
      <p>å°åŒ—å¸‚å¤§å®‰å€è‡¥é¾è¡—278è™Ÿ1æ¨“</p>
    </div>
  </div>

  <div class="notice-section">
    <h3>ğŸ“ é ç´„æé†’</h3>
    <ul>
      <li>é€±ä¸€è‡³é€±äº”ï¼š10:00-12:00, 14:00-18:00</li>
      <li>é€±å…­ï¼š14:00-18:00ï¼ˆé€±æ—¥å…¬ä¼‘ï¼‰</li>
      <li>é ç´„å¾Œå°‡ç”±å°ˆäººé›»è©±ç¢ºèªï¼Œä¸¦ç™¼é€ Google æ—¥æ›†é‚€è«‹ã€‚</li>
    </ul>
  </div>

  <div class="form-section">
    <form id="booking-form">
      <div class="form-group">
        <label>æ‚¨çš„å§“å <span class="required">*</span></label>
        <input type="text" id="name" required placeholder="è«‹è¼¸å…¥å…¨å">
      </div>

      <div class="form-group">
        <label>è¯çµ¡é›»è©± <span class="required">*</span></label>
        <input type="tel" id="phone" required placeholder="09XX-XXX-XXX">
      </div>

      <div class="form-group">
        <label>é›»å­éƒµä»¶ <span class="required">*</span></label>
        <input type="email" id="email" required placeholder="æˆ‘å€‘æœƒç™¼é€è¡Œäº‹æ›†çµ¦æ‚¨">
      </div>

      <div class="form-group">
        <label>é ç´„äººæ•¸ <span class="required">*</span></label>
        <input type="number" id="numberOfPeople" value="1" min="1" max="10">
      </div>

      <div class="form-group">
        <label>é¸æ“‡é ç´„æ—¥æœŸ <span class="required">*</span></label>
        <div id="calendar-render-area"></div>
        <input type="hidden" id="selected-date" required>
      </div>

      <div class="form-group" id="time-section" style="display:none;">
        <label>é¸æ“‡é ç´„æ™‚æ®µ <span class="required">*</span></label>
        <div id="time-slot-area" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
        <input type="hidden" id="selected-time" required>
      </div>

      <div class="form-group">
        <span class="group-title">å¹³å¸¸ç¡å§¿ï¼ˆå¯å¤šé¸ï¼‰<span class="required">*</span></span>
        <div class="checkbox-group">
          <label class="option-card"><input type="checkbox" name="pos" value="ä»°ç¡"> ä»°ç¡</label>
          <label class="option-card"><input type="checkbox" name="pos" value="å´ç¡"> å´ç¡</label>
          <label class="option-card"><input type="checkbox" name="pos" value="è¶´ç¡"> è¶´ç¡</label>
          <label class="option-card">
            <input type="checkbox" name="pos" value="å…¶ä»–" id="pos-other-check"> å…¶ä»–ï¼š
            <input type="text" id="pos-other-text" style="flex:1; border:none; border-bottom:1px solid #ccc; background:transparent;">
          </label>
        </div>
      </div>

      <div class="form-group">
        <span class="group-title">ç›®å‰åºŠå¢Šé¡å‹ <span class="required">*</span></span>
        <div class="radio-group">
          <label class="option-card"><input type="radio" name="mattress" value="ç¨ç«‹ç­’" required> ç¨ç«‹ç­’</label>
          <label class="option-card"><input type="radio" name="mattress" value="ä¹³è† åºŠ"> ä¹³è† åºŠ</label>
          <label class="option-card">
            <input type="radio" name="mattress" value="å…¶ä»–" id="mat-other-check"> å…¶ä»–ï¼š
            <input type="text" id="mat-other-text" style="flex:1; border:none; border-bottom:1px solid #ccc; background:transparent;">
          </label>
        </div>
      </div>

      <div class="form-group">
        <label>ç¡çœ å›°æ“¾æˆ–ç‰¹æ®Šéœ€æ±‚</label>
        <textarea id="special-note" rows="3" placeholder="ä¾‹å¦‚ï¼šè…°ç— ã€æ€•ç†±ã€æˆ–æ˜¯å°æ”¯æ’åŠ›çš„æœŸå¾…..."></textarea>
      </div>

      <button type="submit" class="submit-btn" id="submit-button">ç¢ºèªé€å‡ºé ç´„</button>
    </form>

    <div id="loading-overlay" class="loading-overlay">
      <div style="font-size: 2em;">â³</div>
      <p>æ­£åœ¨ç‚ºæ‚¨è¯ç¹«å¾Œç«¯ç³»çµ±ï¼Œè«‹ç¨å€™...</p>
    </div>

    <div id="success-area" class="hidden" style="text-align: center;">
      <div style="font-size: 5em;">ğŸ‰</div>
      <h2 style="color: #d4a574;">é ç´„ç”³è«‹å·²é€å‡ºï¼</h2>
      <p>å°ˆäººå°‡æ–¼ 1-2 å·¥ä½œå¤©å…§è¯ç¹«ç¢ºèªæ™‚é–“ï¼Œè¬è¬æ‚¨çš„è€å¿ƒç­‰å€™ã€‚</p>
    </div>
  </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpA-p88R_bnjt9ZbkUjg3AafVKjlXWPriDTd71jhTeV6qKcjV4et_honBp1VLx3PN6/exec";

  // 1. æ‰¾å›æœ€å®Œæ•´çš„æ—¥æ›†æ¸²æŸ“é‚è¼¯
  async function fetchCalendar() {
    const area = document.getElementById('calendar-render-area');
    area.innerHTML = "<p>è¼‰å…¥æ—¥æœŸä¸­...</p>";
    try {
      const res = await fetch(`${SCRIPT_URL}?action=getDates`);
      const availableDates = await res.json();
      area.innerHTML = "";
      
      // æŒ‰æœˆä»½åˆ†çµ„
      const groups = {};
      availableDates.forEach(d => {
        const date = new Date(d.value);
        const key = `${date.getFullYear()}å¹´ ${date.getMonth()+1}æœˆ`;
        if(!groups[key]) groups[key] = [];
        groups[key].push(d.value);
      });

      for(const month in groups) {
        const monthBox = document.createElement('div');
        monthBox.innerHTML = `<div class="month-title">${month}</div>`;
        const grid = document.createElement('div');
        grid.className = "calendar-grid";
        
        // æ¸²æŸ“ç©ºæ ¼
        const firstDay = new Date(new Date(groups[month][0]).getFullYear(), new Date(groups[month][0]).getMonth(), 1).getDay();
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

        // æ¸²æŸ“æ—¥æœŸ
        const lastDay = new Date(new Date(groups[month][0]).getFullYear(), new Date(groups[month][0]).getMonth() + 1, 0).getDate();
        const availableSet = new Set(groups[month]);

        for(let d=1; d<=lastDay; d++) {
          const dateStr = `${new Date(groups[month][0]).getFullYear()}-${String(new Date(groups[month][0]).getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const day = document.createElement('div');
          day.className = "calendar-day" + (availableSet.has(dateStr) ? " available" : "");
          day.textContent = d;
          if(availableSet.has(dateStr)) {
            day.onclick = () => {
              document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
              day.classList.add('selected');
              document.getElementById('selected-date').value = dateStr;
              fetchSlots(dateStr);
            };
          }
          grid.appendChild(day);
        }
        monthBox.appendChild(grid);
        area.appendChild(monthBox);
      }
    } catch(e) { area.innerHTML = "ç³»çµ±ç¹å¿™ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚"; }
  }

  // 2. æ‰¾å›æœ€ç©©å®šçš„æ™‚æ®µæŠ“å–
  async function fetchSlots(date) {
    const slotArea = document.getElementById('time-slot-area');
    document.getElementById('time-section').style.display = "block";
    slotArea.innerHTML = "è®€å–æ™‚æ®µ...";
    const res = await fetch(`${SCRIPT_URL}?action=getSlots&date=${date}`);
    const slots = await res.json();
    slotArea.innerHTML = "";
    slots.forEach(s => {
      const btn = document.createElement('div');
      btn.style = "padding:12px; border:2px solid #e8d5c4; border-radius:10px; text-align:center; cursor:pointer; background:#fff;";
      btn.textContent = s.display;
      btn.onclick = () => {
        document.querySelectorAll('#time-slot-area div').forEach(el => {
          el.style.background = "#fff"; el.style.color = "#6b5d52";
        });
        btn.style.background = "#d4a574"; btn.style.color = "#fff";
        document.getElementById('selected-time').value = s.time;
      };
      slotArea.appendChild(btn);
    });
  }

  // 3. æ‰¾å›æœ€ä¿éšªçš„è¡¨å–®æäº¤ï¼ˆå«è·¨åŸŸè™•ç†ï¼‰
  document.getElementById('booking-form').onsubmit = async (e) => {
    e.preventDefault();
    if(!document.getElementById('selected-date').value || !document.getElementById('selected-time').value) {
      alert("è«‹å®Œæ•´é¸æ“‡é ç´„æ—¥æœŸèˆ‡æ™‚æ®µ"); return;
    }

    // è™•ç†è¤‡é¸èˆ‡å…¶ä»–æ¬„ä½
    const pos = Array.from(document.querySelectorAll('input[name="pos"]:checked')).map(el => {
      if(el.value === "å…¶ä»–") return "å…¶ä»–ï¼š" + document.getElementById('pos-other-text').value;
      return el.value;
    }).join('ã€');

    const mat = document.querySelector('input[name="mattress"]:checked').value === "å…¶ä»–" ? 
                "å…¶ä»–ï¼š" + document.getElementById('mat-other-text').value : 
                document.querySelector('input[name="mattress"]:checked').value;

    const payload = {
      name: document.getElementById('name').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      people: document.getElementById('numberOfPeople').value,
      date: document.getElementById('selected-date').value,
      time: document.getElementById('selected-time').value,
      sleepingPosition: pos,
      mattressType: mat,
      note: document.getElementById('special-note').value
    };

    document.getElementById('booking-form').classList.add('hidden');
    document.getElementById('loading-overlay').classList.add('active');

    try {
      // æ¡ç”¨æœ€å‚³çµ±çš„ POST æ–¹å¼ï¼Œç¢ºä¿ GAS èƒ½å¤ æ¥æ”¶
      await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(payload)
      });
      // ç”±æ–¼ no-cors ç„¡æ³•è®€å–å›å‚³ï¼Œæˆ‘å€‘å»¶é²ä¸€é»ç›´æ¥é¡¯ç¤ºæˆåŠŸ
      setTimeout(() => {
        document.getElementById('loading-overlay').classList.remove('active');
        document.getElementById('success-area').classList.remove('hidden');
      }, 1500);
    } catch(e) {
      alert("é ç´„æš«æ™‚ç„¡æ³•é€å‡ºï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç²‰çµ²å°ˆé ã€‚");
      document.getElementById('booking-form').classList.remove('hidden');
      document.getElementById('loading-overlay').classList.remove('active');
    }
  };

  fetchCalendar();
</script>

</body>
</html>
