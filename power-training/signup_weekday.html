<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>平日功率課</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --evening-main: #00838f; --evening-light: #00acc1;
      --morning-main: #ffb300; --morning-light: #ffca28;
      --text-main: #2c3e50; --text-sub: #546e7a; --bg-color: #ffffff;
    }

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background: var(--bg-color); 
      margin: 0; color: var(--text-main); min-height: 100vh; display: flex; justify-content: center; align-items: center; 
    }
    .container { max-width: 800px; width: 100%; margin: 0 auto; padding: 20px; box-sizing: border-box; text-align: center; position: relative; }
    .main-logo { display: block; margin: 0 auto 5px; width: 40px; height: auto; }
    @media (min-width: 751px) { .main-logo { width: 60px; margin-bottom: 10px; } }
    
    h1 { font-size: 32px; margin: 0.1em 0 0.2em; font-weight: 800; letter-spacing: 1px; }
    .user-welcome { font-size: 18px; color: var(--evening-main); margin-bottom: 4px; font-weight: bold; min-height: 24px; }

    .login-section {
        background-color: #fafafa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eee; 
        display: none; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;
    }
    .login-input-group { display: flex; gap: 8px; margin-top: 10px; }
    .login-input { flex: 1; padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
    .login-btn { padding: 10px 20px; font-size: 16px; border-radius: 8px; border: none; background-color: var(--text-main); color: white; cursor: pointer; font-weight: bold; }

    .schedule-box { text-align: left; background: #fafafa; padding: 15px 20px; border-radius: 12px; border: 1px solid #eee; max-width: 600px; margin: 0 auto 15px; }
    .schedule-row { margin: 8px 0; font-size: 16px; color: var(--text-sub); display: flex; align-items: center; }
    .time-badge { display: inline-block; width: 50px; text-align: center; padding: 4px 0; border-radius: 6px; font-size: 14px; margin-right: 12px; font-weight: bold; color: white; }
    .badge-morning { background-color: var(--morning-light); }
    .badge-evening { background-color: var(--evening-light); }
    
    .notice-box {
        text-align: left; background-color: #fff; border-radius: 12px; border: 1px dashed #cfd8dc; 
        font-size: 15px; line-height: 1.6; max-width: 600px; margin: 0 auto 20px; overflow: hidden; cursor: pointer; transition: all 0.3s ease;
    }
    .notice-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .notice-title { font-size: 18px; font-weight: bold; }
    .notice-arrow { font-size: 12px; color: #999; transition: transform 0.3s ease; }
    .notice-content { max-height: 0; opacity: 0; padding: 0 20px; transition: all 0.3s ease-out; overflow: hidden; }
    .notice-box.open { border-style: solid; }
    .notice-box.open .notice-arrow { transform: rotate(180deg); }
    .notice-box.open .notice-content { max-height: 500px; opacity: 1; padding-bottom: 15px; }
    .notice-list { margin: 0; padding-left: 1.4em; color: #666; }
    .sub-item { display: block; margin-top: 4px; font-size: 14px; color: #888; }

    .agreement-container { margin: 20px auto 10px; text-align: center; max-width: 280px; display: none; }
    .agreement-label { display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; user-select: none; }
    .agreement-label input { width: 18px; height: 18px; margin-right: 8px; accent-color: var(--evening-main); }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--evening-main); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { margin-top: 20px; font-size: 18px; color: #666; font-weight: 500; }

    .month-title { font-weight: 800; font-size: 24px; margin: 1.5em 0 0.8em; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .weekday-header { font-weight: bold; font-size: 16px; color: #b0bec5; padding-bottom: 10px; }
    .day { aspect-ratio: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; background-color: #f7f9fa; color: #cfd8dc; transition: all 0.1s; position: relative; }
    .day-number { font-size: 22px; font-weight: bold; }
    .day-label { font-size: 12px; margin-top: 2px; }
    
    .day.available.evening { border: 2px solid var(--evening-main); color: #333; cursor: pointer; background: #fff; }
    .day.available.morning { border: 2px solid var(--morning-main); color: #333; cursor: pointer; background: #fff; }
    .day.selected.evening { background: var(--evening-main); color: #fff; transform: scale(1.05); }
    .day.selected.morning { background: var(--morning-main); color: #fff; transform: scale(1.05); }
    .day.registered { background: #eceff1; border: 2px solid #cfd8dc; color: #b0bec5; }
    .day.full { background: #e0e0e0; opacity: 0.8; border: 2px solid #bbb; color: #666; }

    #submit-btn {
      margin: 15px auto 20px; padding: 16px 0; font-size: 20px; background: var(--evening-main); color: #fff;
      border: none; border-radius: 50px; cursor: pointer; max-width: 260px; display: block; width: 100%; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 131, 143, 0.3);
    }
    #submit-btn:disabled { background-color: #cfd8dc; box-shadow: none; cursor: not-allowed; }

    @media (max-width: 750px) {
      .day { font-size: 18px; } .day-number { font-size: 18px; } .day-label { font-size: 10px; }
      #submit-btn { font-size: 18px; max-width: 60%; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div id="loading-text" class="loading-text">正在放下甜甜圈⋯⋯</div>
  </div>

  <div class="container">
    <img src="logo_icon.png" alt="光聿 Logo" class="main-logo">
    <h1>平日功率課</h1>
    <div id="welcome-msg" class="user-welcome"></div> 

    <div id="login-area" class="login-section">
        <div class="login-title">⚠️ 請驗證會員身分</div>
        <div class="login-input-group">
            <input type="email" id="member-search-email" class="login-input" placeholder="例如：example@gmail.com">
            <button onclick="searchMember()" class="login-btn">驗證</button>
        </div>
        <div id="login-error" style="color:#e53935; margin-top:8px; font-size:13px;"></div>
    </div>

    <div class="schedule-box">
        <div class="schedule-row"><span class="time-badge badge-evening">晚班</span> 週二 / 週四 19:30～21:00</div>
        <div class="schedule-row"><span class="time-badge badge-morning">早班</span> 週三 06:30～08:00</div>
    </div>

    <div class="notice-box" id="notice-box" onclick="toggleNotice()">
        <div class="notice-header">
            <div class="notice-title">課程規範</div>
            <div class="notice-arrow">▼</div> 
        </div>
        <div class="notice-content">
            <ul class="notice-list">
                <li>如需請假，請依時限完成取消：
                    <span class="sub-item">- 早班：前一天 22:00 前</span>
                    <span class="sub-item">- 晚班：當天中午 12:00 前</span>
                </li>
                <li>遲到不另補時，課程仍依原時段進行。</li>
                <li>逾期取消視同上課，扣除１堂課。</li>
                <li>若因生病或突發急事，經告知可免扣堂。</li>
                <li>如遇天災，依行政院公告辦理。</li>
                <li>有任何問題，請直接與教練聯繫。</li>
            </ul>
        </div>
    </div>
    
    <div id="calendar"></div>

    <div id="agreement-area" class="agreement-container">
        <label class="agreement-label">
            <input type="checkbox" id="agree-checkbox">
            我已詳閱，並同意上述課程規範
        </label>
    </div>

    <button id="submit-btn" style="display:none;">送出選課</button>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaAiWuCchIr3I4cpPD0GzWqgE9AW4MEXYuPKOFOldl3mQE1WxjCECssLVetJC5Wb-O/exec";
    const selectedDates = new Set(); 
    let myRegisteredDates = new Set();
    let currentUser = { name: "", lineId: "", email: "" };
    let isSubmitting = false;

    const loadingMessages = ["正在放下甜甜圈⋯⋯", "全力翻找會員資料⋯⋯", "準備好囉 預備備⋯⋯"];
    let msgIndex = 0;
    setInterval(() => {
        const textEl = document.getElementById('loading-text');
        if (textEl && document.getElementById('loading').style.display !== 'none' && !isSubmitting) {
            msgIndex = (msgIndex + 1) % loadingMessages.length;
            textEl.textContent = loadingMessages[msgIndex];
        }
    }, 2000); 

    function toggleNotice() { document.getElementById('notice-box').classList.toggle('open'); }
    function getParam(key) { return new URLSearchParams(window.location.search).get(key) || ''; }

    async function initSystem() {
        let urlName = getParam('name'), urlLineId = getParam('lineId');
        if (urlName && urlLineId) {
            currentUser.name = urlName; currentUser.lineId = urlLineId;
            loginSuccess();
        } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('login-area').style.display = 'block';
        }
    }

    async function searchMember() {
        const emailInput = document.getElementById('member-search-email').value.trim();
        const errorMsg = document.getElementById('login-error'), loadingDiv = document.getElementById('loading');
        if (!emailInput) { errorMsg.textContent = "請輸入 Email"; return; }
        loadingDiv.style.display = 'flex';
        try {
            const res = await fetch(`${SCRIPT_URL}?mode=search_member&email=${encodeURIComponent(emailInput)}`);
            const data = await res.json();
            if (data.found) {
                currentUser.name = data.name; currentUser.lineId = data.lineId; currentUser.email = emailInput;
                loginSuccess();
            } else {
                loadingDiv.style.display = 'none';
                errorMsg.textContent = "❌ 找不到此 Email";
            }
        } catch (e) { loadingDiv.style.display = 'none'; errorMsg.textContent = "系統連線錯誤"; }
    }

    async function loginSuccess() {
        document.getElementById('login-area').style.display = 'none'; 
        document.getElementById('submit-btn').style.display = 'block'; 
        document.getElementById('agreement-area').style.display = 'block'; 
        await renderCalendar();
        document.getElementById('loading').style.display = 'none';
    }

    async function loadMergedData() {
      try {
        const [resEvening, resEarly] = await Promise.all([
            fetch(`${SCRIPT_URL}?mode=powerAllData&lineId=${encodeURIComponent(currentUser.lineId)}&courseType=evening`),
            fetch(`${SCRIPT_URL}?mode=powerAllData&lineId=${encodeURIComponent(currentUser.lineId)}&courseType=early`)
        ]);
        const dataEv = await resEvening.json(), dataEa = await resEarly.json();
        return {
          dates: [...new Set([...(dataEv.dates || []), ...(dataEa.dates || [])])].sort(),
          mySignups: new Set([...(dataEv.mySignups || []), ...(dataEa.mySignups || [])]),
          counts: dataEv.counts || {}
        };
      } catch (error) { return { dates: [], mySignups: new Set(), counts: {} }; }
    }

    async function renderCalendar() {
      const calendarDiv = document.getElementById('calendar'); calendarDiv.innerHTML = '';
      const allData = await loadMergedData();
      const availableDates = allData.dates, signupCounts = allData.counts, availableSet = new Set(availableDates);
      myRegisteredDates = allData.mySignups;

      if (!availableDates.length) {
        calendarDiv.innerHTML = '<div style="color:red; margin-top: 20px;">⚠️ 目前無可預約時段</div>'; return;
      }

      const start = new Date(availableDates[0]), end = new Date(availableDates[availableDates.length - 1]);
      for (let y = start.getFullYear(); y <= end.getFullYear(); y++) {
        for (let m = 0; m < 12; m++) {
          const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
          if (last < start || first > end) continue;
          
          const title = document.createElement('div'); title.className = 'month-title'; title.textContent = `${y}年${m + 1}月`;
          calendarDiv.appendChild(title);
          const grid = document.createElement('div'); grid.className = 'calendar-grid';
          ['日','一','二','三','四','五','六'].forEach(d => {
            const h = document.createElement('div'); h.className = 'weekday-header'; h.textContent = d; grid.appendChild(h);
          });
          for (let i = 0; i < first.getDay(); i++) grid.appendChild(document.createElement('div'));
          
          for (let d = 1; d <= last.getDate(); d++) {
            const dateStr = `${y}/${String(m + 1).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
            const cell = document.createElement('div'); cell.className = 'day';
            const dayOfWeek = new Date(dateStr).getDay();
            let info = { type: "", label: "", theme: "" };

            if (dayOfWeek === 3) info = { type: "early", label: "06:30", theme: "morning" };
            else if (dayOfWeek === 2 || dayOfWeek === 4) info = { type: "evening", label: "19:30", theme: "evening" };

            cell.innerHTML = `<span class="day-number">${d}</span>`;
            const count = info.type === "early" ? (signupCounts[dateStr]?.morning || 0) : (signupCounts[dateStr]?.evening || 0);

            if (myRegisteredDates.has(dateStr)) {
              cell.classList.add('registered'); cell.innerHTML += `<div class="day-label">已登記</div>`;
            } else if (count >= 6 && info.type) {
              cell.classList.add('full'); cell.innerHTML += `<div class="day-label">額滿</div>`;
            } else if (availableSet.has(dateStr) && info.type) {
              cell.classList.add('available', info.theme);
              cell.innerHTML += `<div class="day-label">${info.label}</div>`;
              cell.onclick = () => {
                selectedDates.has(dateStr) ? selectedDates.delete(dateStr) : selectedDates.add(dateStr);
                cell.classList.toggle('selected'); updateSubmitButton();
              };
            }
            grid.appendChild(cell);
          }
          calendarDiv.appendChild(grid);
        }
      }
    }

    function updateSubmitButton() {
        const btn = document.getElementById('submit-btn');
        btn.textContent = selectedDates.size > 0 ? `確認送出 (${selectedDates.size}堂)` : "請先選擇日期";
        btn.disabled = selectedDates.size === 0;
    }

    document.getElementById('submit-btn').addEventListener('click', async () => {
      if (!document.getElementById('agree-checkbox').checked) { alert('請勾選同意課程規範'); return; }
      isSubmitting = true; document.getElementById('loading').style.display = 'flex';
      try {
        for (const date of selectedDates) {
          const type = new Date(date).getDay() === 3 ? "early" : "evening";
          await fetch(`${SCRIPT_URL}?mode=submit&date=${encodeURIComponent(date)}&courseType=${type}&name=${encodeURIComponent(currentUser.name)}&lineId=${encodeURIComponent(currentUser.lineId)}&email=${encodeURIComponent(currentUser.email)}`);
        }
        alert('✅ 登記成功！');
        window.location.href = window.location.pathname + '?name=' + encodeURIComponent(currentUser.name) + '&lineId=' + encodeURIComponent(currentUser.lineId);
      } catch (error) { isSubmitting = false; document.getElementById('loading').style.display = 'none'; alert('⚠️ 發生錯誤'); }
    });

    initSystem();
  </script>
</body>
</html>
