<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ™šç­åŠŸç‡èª²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body {
  font-family: Arial, sans-serif;
  background: #ffffff;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}
h1 {
  font-size: 36px;
  margin: 0.5em 0 0.2em;
}
.info {
  font-size: 24px;
  color: #666;
  margin-bottom: 1.5em;
}

/* è¼‰å…¥å‹•ç•«æ¨£å¼ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #00bcd4;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.loading-text {
  margin-top: 20px;
  font-size: 18px;
  color: #666;
}

.month-title {
  font-weight: bold;
  font-size: 32px;
  margin: 2em 0 0.8em;
}
.calendar-header,
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;  /* âœ¨ åŸæœ¬ 4px â†’ 8pxï¼ˆæ ¼å­é–“è·è®Šå¤§ï¼Œæ ¼å­æœƒè‡ªå‹•è®Šå°ï¼‰*/
  padding: 0;
  box-sizing: border-box;
  max-width: 100%;
}
.weekday-header {
  font-weight: bold;
  font-size: 20px;
  text-align: center;
  color: #888;
  padding-bottom: 20px;  /* âœ¨ åŸæœ¬ 10px â†’ 20pxï¼ˆæ‹‰é–‹è·é›¢ï¼‰*/
}
.day {
  aspect-ratio: 1;
  max-width: 100%;
  width: 100%;
  font-size: 28px;  /* âœ¨ åŸæœ¬ 22px â†’ 28pxï¼ˆæ•¸å­—è®Šå¤§ï¼‰*/
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;  /* âœ¨ åŸæœ¬ 6px â†’ 12pxï¼ˆè§’æ›´åœ“ï¼‰*/
  background-color: #eeeeee;
  color: #aaa;
  cursor: default;
  box-sizing: border-box;
}
.day.available {
  background-color: #b2ebf2;
  color: #000;
  cursor: pointer;
  border: 1px solid #00bcd4;
}
.day.selected {
  background-color: #00bcd4;
  font-weight: bold;
  color: #fff;
}
.day.registered {
  background-color: #80deea;
  color: #000;
  cursor: not-allowed;
  border: 2px solid #00bcd4;
  opacity: 0.7;
}
.day.full {
  background-color: #e0e0e0;
  color: #666;
  cursor: not-allowed;
  border: 2px solid #00bcd4;
  opacity: 0.8;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 4px;
  position: relative;
}
.day.full .date-number {
  font-size: 28px;  /* âœ¨ åŸæœ¬ 22px â†’ 28pxï¼ˆé…åˆæ•´é«”æ•¸å­—å¤§å°ï¼‰*/
  line-height: 1;
  margin-top: -4px;
}
.day.full .full-label {
  font-size: 12px;
  line-height: 1;
}
#submit-btn {
  margin: 3em auto 2em;  /* âœ¨ åŸæœ¬ 2em auto â†’ 3em auto 2emï¼ˆå¾€ä¸‹ç§»ä¸€é»ï¼‰*/
  padding: 16px 32px;
  font-size: 22px;
  background: #00bcd4;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  max-width: 60%;
  display: block;
}
#message {
  font-size: 16px;
  margin-top: 1em;
  font-weight: bold;
}

/* ğŸ”’ æ‰‹æ©Ÿç‰ˆå®Œå…¨ä¸æ”¹ï¼ˆç¶­æŒåŸæ¨£ï¼‰*/
@media (max-width: 750px) {
  h1 { font-size: 28px; margin-bottom: 0.4em; }
  .info { font-size: 18px; margin-bottom: 1em; }
  .month-title { font-size: 24px; margin: 1.5em 0 0.6em; }
  .container { padding: 0.5em; }
  .calendar-header,
  .calendar-grid { gap: 3px; padding: 0; }
  .weekday-header { font-size: 16px; padding-bottom: 3px; }
  .day { font-size: 18px; border-radius: 6px; }
  .day.full { gap: 3px; }
  .day.full .date-number { font-size: 16px; margin-top: -3px; }
  .day.full .full-label { font-size: 11px; }
  #submit-btn { font-size: 18px; padding: 12px 22px; }
  .loading-text { font-size: 16px; }
}
</style>
</head>
<body>
  <!-- è¼‰å…¥å‹•ç•« -->
  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">è¼‰å…¥ä¸­...</div>
  </div>

  <div class="container">
    <h1>æ™šç­åŠŸç‡èª²</h1>
    <div class="info">æ¯é€±äºŒ / é€±å›› 19:30ï½21:00</div>
    <div id="calendar"></div>
    <button id="submit-btn">é€å‡ºå ±å</button>
    <div id="message"></div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaAiWuCchIr3I4cpPD0GzWqgE9AW4MEXYuPKOFOldl3mQE1WxjCECssLVetJC5Wb-O/exec";

    const selectedDates = new Set();
    let myRegisteredDates = new Set();

    function getParam(key) { 
      return new URLSearchParams(window.location.search).get(key) || ''; 
    }

    const lineId = getParam('lineId');
    const name = getParam('name');

    // åˆä½µç‰ˆ APIï¼šä¸€æ¬¡å–å¾—æ‰€æœ‰è³‡æ–™
    async function loadAllData() {
      try {
        const res = await fetch(`${SCRIPT_URL}?mode=powerAllData&lineId=${encodeURIComponent(lineId)}&courseType=evening`);
        const data = await res.json();
        return {
          dates: data.dates || [],
          mySignups: new Set(data.mySignups || []),
          counts: data.counts || {}
        };
      } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
        return {
          dates: [],
          mySignups: new Set(),
          counts: {}
        };
      }
    }

    async function renderCalendar() {
      const calendarDiv = document.getElementById('calendar');
      const loadingDiv = document.getElementById('loading');
      
      // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
      loadingDiv.style.display = 'flex';
      calendarDiv.innerHTML = '';

      // åªå‘¼å« 1 æ¬¡ APIï¼Œå–å¾—æ‰€æœ‰è³‡æ–™
      const allData = await loadAllData();
      const availableDates = allData.dates;
      myRegisteredDates = allData.mySignups;
      const signupCounts = allData.counts;

      // éš±è—è¼‰å…¥å‹•ç•«
      loadingDiv.style.display = 'none';

      const availableSet = new Set(availableDates);

      if (!availableDates.length) {
        calendarDiv.innerHTML = '<div style="color:red;">âš ï¸ ç„¡å¯ç™»è¨˜æ—¥æœŸ</div>';
        return;
      }

      const start = new Date(availableDates[0]);
      const end = new Date(availableDates[availableDates.length - 1]);

      for (let y = start.getFullYear(); y <= end.getFullYear(); y++) {
        for (let m = 0; m < 12; m++) {
          const first = new Date(y, m, 1);
          const last = new Date(y, m + 1, 0);
          if (last < start || first > end) continue;

          const title = document.createElement('div');
          title.className = 'month-title';
          title.textContent = `${y}å¹´${m + 1}æœˆ`;
          calendarDiv.appendChild(title);

          const header = document.createElement('div');
          header.className = 'calendar-header';
          ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => {
            const h = document.createElement('div');
            h.className = 'weekday-header';
            h.textContent = d;
            header.appendChild(h);
          });
          calendarDiv.appendChild(header);

          const grid = document.createElement('div');
          grid.className = 'calendar-grid';

          for (let i = 0; i < first.getDay(); i++) {
            const cell = document.createElement('div');
            cell.className = 'day';
            grid.appendChild(cell);
          }

          for (let d = 1; d <= last.getDate(); d++) {
            const dateStr = `${y}/${String(m + 1).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
            const cell = document.createElement('div');
            cell.className = 'day';
            cell.textContent = d;

            const dayOfWeek = new Date(dateStr).getDay();

            let currentCount = 0;
            if (signupCounts[dateStr]) {
              currentCount = signupCounts[dateStr].evening || 0;
            }
            const isFull = currentCount >= 6;

            if (myRegisteredDates.has(dateStr)) {
              cell.classList.add('registered');
              cell.textContent = d + ' âœ“';
            } else if (isFull && (dayOfWeek === 2 || dayOfWeek === 4)) {
              cell.classList.add('full');
              cell.innerHTML = `<div class="date-number">${d}</div><div class="full-label">é¡æ»¿</div>`;
            } else if (availableSet.has(dateStr) && (dayOfWeek === 2 || dayOfWeek === 4)) {
              cell.classList.add('available');
              cell.onclick = () => {
                if (selectedDates.has(dateStr)) {
                  selectedDates.delete(dateStr);
                  cell.classList.remove('selected');
                } else {
                  selectedDates.add(dateStr);
                  cell.classList.add('selected');
                }
              };
            }

            grid.appendChild(cell);
          }
          calendarDiv.appendChild(grid);
        }
      }
    }

    document.getElementById('submit-btn').addEventListener('click', async () => {
      if (!selectedDates.size) {
        alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');
        return;
      }

      const msg = document.getElementById('message');
      const loadingDiv = document.getElementById('loading');
      
      loadingDiv.style.display = 'flex';
      msg.textContent = '';

      try {
        for (const date of selectedDates) {
          await fetch(`${SCRIPT_URL}?mode=submit&date=${encodeURIComponent(date)}&courseType=evening&name=${encodeURIComponent(name)}&lineId=${encodeURIComponent(lineId)}`);
        }

        loadingDiv.style.display = 'none';
        msg.textContent = 'âœ… ç™»è¨˜å®Œæˆ';
        alert('âœ… ç™»è¨˜æˆåŠŸï¼');
        selectedDates.clear();
        renderCalendar();
      } catch (error) {
        console.error('æäº¤éŒ¯èª¤:', error);
        loadingDiv.style.display = 'none';
        msg.textContent = 'âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
      }
    });

    renderCalendar();
  </script>
</body>
</html>
