<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…‰è¿å–®å ‚åŠŸç‡é«”é©—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* =========================================
       ğŸ¨ é…è‰²å®šç¾©
       ========================================= */
    :root {
      /* æ™šç­ - å°ˆæ¥­è— */
      --evening-main: #00838f; 
      --evening-light: #00acc1;
      --evening-bg: #e0f7fa;
      
      /* æ—©ç­ - æ´»åŠ›é»ƒ */
      --morning-main: #ffb300; 
      --morning-light: #ffca28;
      --morning-bg: #fff8e1;

      /* åƒ¹æ ¼å€å¡Š - éˆ”ç¥¨ç¶  */
      --price-bg: #e8f5e9;
      --price-text: #2e7d32;
      
      /* ç³»çµ±è‰² */
      --text-main: #2c3e50;
      --cancel-gold: #ffa000;
    }

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: #f5f5f5; 
      margin: 0;
      padding: 0;
      color: #333;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center; 
    }
    .container {
      max-width: 500px; 
      width: 100%;
      margin: 20px auto;
      padding: 30px 25px;
      box-sizing: border-box;
      text-align: center;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      position: relative;
    }

    /* =========================================
       ğŸ”¥ Logo è¨­å®š
       ========================================= */
    .main-logo {
        display: block;
        margin: 0 auto 5px;
        width: 40px;
        height: auto;
    }

    @media (min-width: 601px) {
        .main-logo {
            width: 60px;
            margin-bottom: 10px;
        }
    }

    h1 {
      font-size: 28px;
      margin: 0.1em 0 0.6em;
      color: #2c3e50;
      font-weight: 800;
      letter-spacing: 1px;
    }

    /* === ğŸ“… èª²ç¨‹æ™‚é–“è¡¨ === */
    .schedule-box {
      text-align: left;
      display: block; 
      margin-bottom: 20px;
      background: #fafafa;
      padding: 15px 20px;
      border-radius: 12px;
      border: 1px solid #eee;
    }
    .schedule-row {
      margin: 8px 0;
      font-size: 16px;
      color: #555;
      display: flex;
      align-items: center;
    }
    
    .time-badge {
        display: inline-block;
        width: 45px;
        text-align: center;
        padding: 4px 0;
        border-radius: 6px;
        font-size: 14px;
        margin-right: 12px;
        font-weight: bold;
        color: white;
        flex-shrink: 0; 
    }
    .badge-morning { background-color: var(--morning-light); }
    .badge-evening { background-color: var(--evening-light); }

    /* === ğŸ’° åƒ¹æ ¼èˆ‡å„ªæƒ èªªæ˜å€ === */
    .price-info {
        background-color: var(--price-bg);
        color: var(--price-text);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        text-align: left;
        border: 1px solid #c8e6c9;
    }
    .price-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        border-bottom: 1px dashed #a5d6a7;
        padding-bottom: 10px;
    }
    .price-title span { font-size: 24px; margin-left: auto; color: #1b5e20; }
    .price-desc {
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.95;
    }
    .price-highlight {
        font-weight: bold;
        color: #1b5e20;
        background: rgba(165, 214, 167, 0.3);
        padding: 0 4px;
        border-radius: 4px;
    }
    .price-example {
        margin-top: 10px;
        font-size: 13px;
        color: #1b5e20;
        background: rgba(255,255,255,0.6);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #a5d6a7;
    }
    .payment-notice {
        margin-top: 10px;
        color: #d32f2f;
        font-weight: bold;
        font-size: 13px;
        display: flex;
        align-items: flex-start;
    }

    /* ğŸ“ è¨ªå®¢è³‡æ–™è¼¸å…¥å€ */
    .guest-form {
        background-color: #ffffff;
        padding: 10px 0;
        margin-bottom: 20px;
        text-align: left;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
        color: #455a64;
        font-size: 14px;
    }
    .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.3s ease;
        background-color: #fafafa;
    }
    .form-group input:focus {
        border-color: var(--evening-light);
        background-color: #fff;
        outline: none;
    }
    
    /* è¼‰å…¥å‹•ç•« */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.98);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--evening-main);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { margin-top: 15px; font-size: 16px; color: #666; font-weight: 500; }

    /* Modal å½ˆçª—æ¨£å¼ */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 10000; }
    .modal-box { background: white; padding: 30px; border-radius: 24px; text-align: center; max-width: 320px; width: 85%; box-shadow: 0 15px 35px rgba(0,0,0,0.2); animation: modalShow 0.3s ease-out; }
    @keyframes modalShow { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-title { font-size: 20px; font-weight: 800; color: #2c3e50; margin-bottom: 10px; }
    
    .modal-btn { 
        margin-top: 20px; padding: 12px 0; border-radius: 50px; border: none; 
        background: var(--evening-main); color: white; font-weight: bold; cursor: pointer; 
        width: 100%; display: block;
        font-size: 16px; transition: background 0.2s; 
    }
    .modal-btn:hover { background: var(--evening-light); }

    .btn-red { background-color: #ff5252 !important; }
    .btn-gray { background-color: #eee !important; color: #333 !important; }

    /* æ—¥æ›†æ¨£å¼ */
    .month-title {
      font-weight: 800;
      font-size: 20px;
      margin: 1.5em 0 0.8em;
      color: #37474f;
    }
    .calendar-header, .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .weekday-header {
      font-weight: bold;
      font-size: 13px;
      text-align: center;
      color: #b0bec5;
      padding-bottom: 8px; 
    }
    .day {
      aspect-ratio: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px; 
      background-color: #f7f9fa;
      color: #cfd8dc;
      position: relative;
    }
    .day-number { font-size: 16px; font-weight: 600; }
    .day-label { font-size: 10px; }

    /* === æ™šç­æ¨£å¼ === */
    .day.available.evening {
      background-color: #fff;
      color: #333;
      border: 2px solid var(--evening-main);
      cursor: pointer;
    }
    .day.available.evening .day-label { color: var(--evening-main); font-weight: 800; }
    
    .day.selected.evening {
      background-color: var(--evening-main);
      color: #fff;
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(0, 131, 143, 0.4);
    }
    .day.selected.evening .day-label { color: #fff; }

    /* === æ—©ç­æ¨£å¼ === */
    .day.available.morning {
      background-color: #fff;
      color: #333;
      border: 2px solid var(--morning-main);
      cursor: pointer;
    }
    .day.available.morning .day-label { color: var(--morning-main); font-weight: 800; }

    .day.selected.morning {
      background-color: var(--morning-main);
      color: #fff;
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(255, 179, 0, 0.4);
    }
    .day.selected.morning .day-label { color: #fff; }
    
    .day.registered.can-cancel.evening { background-color: #e0f2f1 !important; border: 2px solid var(--evening-main) !important; color: var(--evening-main) !important; cursor: pointer !important; }
    .day.registered.can-cancel.morning { background-color: #fff8e1 !important; border: 2px solid var(--morning-main) !important; color: var(--morning-main) !important; cursor: pointer !important; }
    
    .day.registered { background-color: #eceff1; color: #b0bec5; border: 2px solid #cfd8dc; }
    .day.full { background-color: #f5f5f5; color: #bdbdbd; border: 1px dashed #e0e0e0; }

    #submit-btn {
      margin: 20px auto 10px; 
      padding: 14px 0;
      font-size: 18px;
      background: #cfd8dc;
      color: #fff;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      body { align-items: flex-start; background: #fff; } 
      .container { margin: 0; padding: 20px; box-shadow: none; border-radius: 0; }
    }
  </style>
</head>
<body>
  <div id="cancel-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="cancel-modal-title">èª¿æ•´ç™»è¨˜</div>
        <div id="cancel-modal-msg" style="color: #444; font-size: 16px; line-height: 1.8; margin: 15px 0;"></div>
        <div id="cancel-modal-footer" style="display: flex; gap: 10px; justify-content: center;">
          <button class="modal-btn btn-gray" onclick="closeCancelModal()">å…ˆä¸è¦</button>
          <button class="modal-btn btn-red" id="confirm-cancel-btn">å–æ¶ˆç™»è¨˜</button>
        </div>
        <button id="cancel-close-btn" class="modal-btn" style="display:none;" onclick="closeCancelModal()">ç¢ºå®š</button>
    </div>
  </div>

  <div id="alert-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="alert-title">æç¤º</div>
        <div id="alert-msg" style="color: #444; font-size: 15px; line-height: 1.6; margin: 15px 0; text-align: left;"></div>
        <button class="modal-btn" id="alert-btn">ç¢ºå®š</button>
    </div>
  </div>

  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">è¼‰å…¥èª²ç¨‹è³‡è¨Š...</div>
  </div>

  <div class="container">
    <img src="logo_icon.png" alt="å…‰è¿ Logo" class="main-logo">
    <h1>å…‰è¿å–®å ‚åŠŸç‡é«”é©—</h1>
    
    <div class="schedule-box">
        <div class="schedule-row"><span class="time-badge badge-evening">æ™šç­</span> é€±äºŒ / é€±å›› 19:30ï½21:00</div>
        <div class="schedule-row"><span class="time-badge badge-morning">æ—©ç­</span> é€±ä¸‰ 06:30ï½08:00</div>
    </div>
    
    <div class="price-info">
        <div class="price-title">å–®å ‚é«”é©—è²»ç”¨ <span>$660</span></div>
        <div class="price-desc">
            ğŸ’¡ <strong>è³¼èª²æŠ˜æŠµå„ªæƒ ï¼š</strong><br>
            å¾ŒçºŒè³¼è²·æ­£å¼èª²å¡ï¼Œæœ¬å ‚é«”é©—è²» <span class="price-highlight">å¯å…¨é¡æŠ˜æŠµ</span>ã€‚<br>
            <div class="price-example">
                ä¾‹å¦‚ï¼šè³¼è²· 10 å ‚æ–¹æ¡ˆ ($5500)<br>
                æ‰£é™¤å·²ä»˜ $660ï¼Œ<strong>åƒ…éœ€è£œå·®é¡ $4840</strong>
            </div>
            <div class="payment-notice">
                âš ï¸ æ³¨æ„ï¼šé ç´„æˆåŠŸå¾Œè«‹æ–¼ 24 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ä»¥ä¿ç•™å¸­ä½ã€‚
            </div>
        </div>
    </div>

    <div class="guest-form">
        <div class="form-group"><label>çœŸå¯¦å§“å</label><input type="text" id="guest-name" placeholder="è«‹è¼¸å…¥å§“å" required></div>
        <div class="form-group"><label>è¯çµ¡é›»è©±</label><input type="tel" id="guest-phone" placeholder="09xxxxxxxx" required></div>
        <div class="form-group"><label>Email (æ¥æ”¶æ—¥æ›†é‚€è«‹)</label><input type="email" id="guest-email" placeholder="example@gmail.com" required></div>
    </div>

    <div id="calendar"></div>
    <button id="submit-btn" disabled>è«‹å…ˆé¸æ“‡æ—¥æœŸ</button>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaAiWuCchIr3I4cpPD0GzWqgE9AW4MEXYuPKOFOldl3mQE1WxjCECssLVetJC5Wb-O/exec";
    let selectedDate = null; 
    let selectedType = ""; 
    let countdownInterval = null;
    let myTrialSignups = JSON.parse(localStorage.getItem('myTrialSignups')) || [];

    function closeCancelModal() { document.getElementById('cancel-modal').style.display = 'none'; if (countdownInterval) clearInterval(countdownInterval); }

    function showSystemAlert(title, message, callback) {
        document.getElementById('alert-title').textContent = title;
        document.getElementById('alert-msg').innerHTML = message;
        const btn = document.getElementById('alert-btn');
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = () => {
             document.getElementById('alert-modal').style.display = 'none';
             if (callback) callback();
        };
        document.getElementById('alert-modal').style.display = 'flex';
    }

    async function loadData() {
      try {
        const res = await fetch(`${SCRIPT_URL}?mode=powerAllData&courseType=evening`);
        return await res.json();
      } catch (error) {
        alert('ç„¡æ³•é€£çµä¼ºæœå™¨');
        return null;
      }
    }

    async function renderCalendar() {
      const calendarDiv = document.getElementById('calendar');
      const loadingDiv = document.getElementById('loading');
      loadingDiv.style.display = 'flex';
      calendarDiv.innerHTML = '';
      const allData = await loadData();
      loadingDiv.style.display = 'none';
      if (!allData || !allData.dates) return;

      const availableSet = new Set(allData.dates);
      const signupCounts = allData.counts || {};
      const start = new Date(allData.dates[0]);
      const end = new Date(allData.dates[allData.dates.length - 1]);

      for (let y = start.getFullYear(); y <= end.getFullYear(); y++) {
        for (let m = 0; m < 12; m++) {
          const first = new Date(y, m, 1);
          const last = new Date(y, m + 1, 0);
          if (last < start || first > end) continue; 

          const title = document.createElement('div');
          title.className = 'month-title';
          title.textContent = `${y}å¹´${m + 1}æœˆ`;
          calendarDiv.appendChild(title);

          const header = document.createElement('div');
          header.className = 'calendar-header';
          ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => {
            const h = document.createElement('div');
            h.className = 'weekday-header'; h.textContent = d;
            header.appendChild(h);
          });
          calendarDiv.appendChild(header);

          const grid = document.createElement('div');
          grid.className = 'calendar-grid';
          for (let i = 0; i < first.getDay(); i++) grid.appendChild(document.createElement('div'));

          for (let d = 1; d <= last.getDate(); d++) {
            const dateStr = `${y}/${String(m + 1).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
            const cell = document.createElement('div');
            cell.className = 'day';
            const numSpan = document.createElement('span');
            numSpan.className = 'day-number'; numSpan.textContent = d;
            cell.appendChild(numSpan);

            const dayOfWeek = new Date(dateStr).getDay();
            const myRecord = myTrialSignups.find(r => r.date === dateStr);

            if (myRecord) {
                const diff = new Date().getTime() - myRecord.timestamp;
                const theme = (dayOfWeek === 3) ? 'morning' : 'evening';
                if (diff <= 600000) {
                    cell.classList.add('registered', 'can-cancel', theme);
                    const l = document.createElement('div'); l.className = 'day-label'; l.textContent = "å·²ç™»è¨˜"; cell.appendChild(l);
                    cell.onclick = () => {
                        const update = () => {
                            const remain = 600000 - (new Date().getTime() - myRecord.timestamp);
                            const msg = document.getElementById('cancel-modal-msg'), title = document.getElementById('cancel-modal-title');
                            const footer = document.getElementById('cancel-modal-footer'), close = document.getElementById('cancel-close-btn');
                            if (remain > 0) {
                                title.textContent = "å–æ¶ˆç™»è¨˜";
                                msg.innerHTML = `æ‚¨å·²ç™»è¨˜ ${dateStr}ã€‚<br>é‚„æœ‰ <b style="font-size: 20px; color: var(--cancel-gold);">${Math.floor(remain/60000)}åˆ†${Math.floor((remain%60000)/1000)}ç§’</b> å¯å–æ¶ˆã€‚`;
                                footer.style.display = 'flex'; close.style.display = 'none';
                                document.getElementById('confirm-cancel-btn').onclick = () => { closeCancelModal(); handleCancel(dateStr, myRecord.lineId); };
                            } else {
                                if (countdownInterval) clearInterval(countdownInterval);
                                title.textContent = "é ç´„å·²é–å®š"; msg.innerHTML = `å·²è¶…éå¯å–æ¶ˆæ™‚é™ã€‚<br>å¦‚éœ€è«‹å‡è«‹ç§è¨Šæ•™ç·´ã€‚`;
                                footer.style.display = 'none'; close.style.display = 'block';
                            }
                            document.getElementById('cancel-modal').style.display = 'flex';
                        };
                        update(); if (countdownInterval) clearInterval(countdownInterval); countdownInterval = setInterval(update, 1000);
                    };
                } else {
                    cell.classList.add('registered');
                    const l = document.createElement('div'); l.className = 'day-label'; l.textContent = "å·²ç™»è¨˜"; cell.appendChild(l);
                }
            } else if (availableSet.has(dateStr)) {
                let type = (dayOfWeek === 3) ? "morning" : "evening";
                let count = signupCounts[dateStr] ? (signupCounts[dateStr][type] || 0) : 0;
                if (count >= 6) {
                    cell.classList.add('full');
                    const fl = document.createElement('div'); fl.className = 'full-label'; fl.textContent = "é¡æ»¿"; cell.appendChild(fl);
                } else {
                    cell.classList.add('available', type);
                    const tl = document.createElement('div'); tl.className = 'day-label'; tl.textContent = (dayOfWeek === 3 ? "06:30" : "19:30"); cell.appendChild(tl);
                    cell.onclick = () => handleSelection(cell, dateStr, type);
                }
            }
            grid.appendChild(cell);
          }
          calendarDiv.appendChild(grid);
        }
      }
    }

    async function handleCancel(dateStr, fakeLineId) {
      const loadingDiv = document.getElementById('loading');
      loadingDiv.style.display = 'flex';
      try {
        const res = await fetch(`${SCRIPT_URL}?mode=cancel&date=${encodeURIComponent(dateStr)}&lineId=${encodeURIComponent(fakeLineId)}`);
        const data = await res.json();
        loadingDiv.style.display = 'none';
        if (data.status === 'success') {
             myTrialSignups = myTrialSignups.filter(r => r.date !== dateStr);
             localStorage.setItem('myTrialSignups', JSON.stringify(myTrialSignups));
             showSystemAlert('å–æ¶ˆæˆåŠŸï¼', '', () => { location.reload(); });
        } else {
             showSystemAlert('æç¤º', data.message, () => { location.reload(); });
        }
      } catch (e) { loadingDiv.style.display = 'none'; }
    }

    function handleSelection(cell, dateStr, type) {
        const btn = document.getElementById('submit-btn');
        if (selectedDate === dateStr) {
            selectedDate = null; selectedType = ""; cell.classList.remove('selected');
            btn.style.backgroundColor = '#cfd8dc'; btn.textContent = "è«‹å…ˆé¸æ“‡æ—¥æœŸ"; btn.disabled = true;
        } else {
            document.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
            selectedDate = dateStr; selectedType = type; cell.classList.add('selected');
            btn.disabled = false; btn.textContent = "ç¢ºèªé ç´„";
            btn.style.backgroundColor = (type === 'morning') ? '#ffca28' : '#00acc1';
        }
    }

    document.getElementById('submit-btn').addEventListener('click', async () => {
        const name = document.getElementById('guest-name').value.trim();
        const phone = document.getElementById('guest-phone').value.trim();
        const email = document.getElementById('guest-email').value.trim();
        if (!name || !phone || !email) { showSystemAlert('æç¤º', 'è«‹å®Œæ•´å¡«å¯«å§“åã€é›»è©±ã€Email'); return; }

        const timeInfo = selectedType === "morning" ? "æ—©ç­ 06:30" : "æ™šç­ 19:30";
        const msg = `ã€é ç´„ç¢ºèªã€‘\n\næ—¥æœŸï¼š${selectedDate}\næ™‚æ®µï¼š${timeInfo}\nè²»ç”¨ï¼š$660\n\nâ€» è¦ç¯„æé†’ï¼š\n1. é ç´„å¾Œè«‹æ–¼ 24 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ã€‚\n2. åŒ¯æ¬¾å¾Œè«‹ç§è¨Šå¾Œäº”ç¢¼ä»¥ä¾¿æ•™ç·´ä¿ç•™å¸­ä½ã€‚\n3. è‹¥ç„¡æ•…ç¼ºå¸­ï¼Œè²»ç”¨å°‡ä¸äºˆé€€é‚„ã€‚\n\nç¢ºèªé€å‡ºé ç´„ï¼Ÿ`;
        if (!confirm(msg)) return;

        const loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = 'flex';
        try {
            const params = new URLSearchParams({ mode: 'trial_submit', date: selectedDate, name, phone, email });
            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();
            loadingDiv.style.display = 'none';
            if (result.status === 'success') {
                myTrialSignups.push({ date: selectedDate, lineId: "TRIAL_" + phone, timestamp: new Date().getTime() });
                localStorage.setItem('myTrialSignups', JSON.stringify(myTrialSignups));
                
                const successMsg = `âœ… é ç´„ç”³è«‹å·²é€å‡ºï¼<br><br><b>ã€ä¸‹ä¸€æ­¥ï¼šä¿ç•™å¸­ä½ã€‘</b><br>è«‹åŒ¯æ¬¾è‡³ï¼š<b>ä¸­åœ‹ä¿¡è¨— (822) XXXXXXXXX</b><br>é‡‘é¡ï¼š<b>$660</b><br><br>å®Œæˆå¾Œè«‹ç§è¨Šã€Œå…‰è¿å·¥ä½œå®¤ã€å‘ŠçŸ¥å¾Œäº”ç¢¼ï¼Œå‡¡å‡¡æ•™ç·´å°‡ç‚ºæ‚¨æ­£å¼ç¢ºèªã€‚`;
                showSystemAlert('é ç´„æˆåŠŸ', successMsg, () => { location.reload(); });
            } else {
                showSystemAlert('é ç´„å¤±æ•—', result.message);
            }
        } catch (error) { loadingDiv.style.display = 'none'; }
    });

    renderCalendar();
  </script>
</body>
</html>
