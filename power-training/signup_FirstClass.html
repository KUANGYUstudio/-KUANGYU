<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…‰è¿å–®å ‚åŠŸç‡é«”é©—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* =========================================
       ğŸ¨ é…è‰²å®šç¾©
       ========================================= */
    :root {
      /* æ™šç­ - å°ˆæ¥­è— */
      --evening-main: #00838f; 
      --evening-light: #00acc1;
      --evening-bg: #e0f7fa;
      
      /* æ—©ç­ - æ´»åŠ›é»ƒ */
      --morning-main: #ffb300; 
      --morning-light: #ffca28;
      --morning-bg: #fff8e1;

      /* åƒ¹æ ¼å€å¡Š - éˆ”ç¥¨ç¶  */
      --price-bg: #e8f5e9;
      --price-text: #2e7d32;
      
      /* ç³»çµ±è‰² */
      --text-main: #2c3e50;
      --cancel-gold: #ffa000;
    }

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: #f5f5f5; 
      margin: 0;
      padding: 0;
      color: #333;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center; 
    }
    .container {
      max-width: 500px; 
      width: 100%;
      margin: 20px auto;
      padding: 30px 25px;
      box-sizing: border-box;
      text-align: center;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      position: relative;
    }

    /* =========================================
       ğŸ”¥ Logo è¨­å®š (çµ±ä¸€ç½®ä¸­ï¼Œæ‰‹æ©Ÿå„ªå…ˆ)
       ========================================= */
    .main-logo {
        display: block;
        margin: 0 auto 5px; /* ç½®ä¸­ï¼Œä¸‹æ–¹ç•™ä¸€é»ç™½ */
        width: 40px;        /* ğŸ¯ æ‰‹æ©Ÿç‰ˆé è¨­å¤§å°ï¼š40px */
        height: auto;
    }

    /* ğŸ’» é›»è…¦ç‰ˆè®Šå¤§ (ç•¶è¢å¹•å¤§æ–¼ 600px æ™‚) */
    @media (min-width: 601px) {
        .main-logo {
            width: 60px;     /* ğŸ¯ é›»è…¦ç‰ˆå¤§å°ï¼š60px */
            margin-bottom: 10px;
        }
    }

    h1 {
      font-size: 28px;
      margin: 0.1em 0 0.6em; /* é…åˆä¸Šæ–¹ Logoï¼Œç¸®å°é–“è· */
      color: #2c3e50;
      font-weight: 800;
      letter-spacing: 1px;
    }

    /* === ğŸ“… èª²ç¨‹æ™‚é–“è¡¨ === */
    .schedule-box {
      text-align: left;
      display: block; 
      margin-bottom: 20px;
      background: #fafafa;
      padding: 15px 20px;
      border-radius: 12px;
      border: 1px solid #eee;
    }
    .schedule-row {
      margin: 8px 0;
      font-size: 16px;
      color: #555;
      display: flex;
      align-items: center;
    }
    
    .time-badge {
        display: inline-block;
        width: 45px;
        text-align: center;
        padding: 4px 0;
        border-radius: 6px;
        font-size: 14px;
        margin-right: 12px;
        font-weight: bold;
        color: white;
        flex-shrink: 0; 
    }
    .badge-morning { background-color: var(--morning-light); }
    .badge-evening { background-color: var(--evening-light); }

    /* === ğŸ’° åƒ¹æ ¼èˆ‡èªªæ˜å€ (æ”¹ç‚ºæŠ˜ç–Šå¼) === */
    /* å®¹å™¨æ¨£å¼ */
    .accordion-box {
        border-radius: 12px;
        margin-bottom: 15px;
        overflow: hidden;
        border: 1px solid #eee;
        transition: all 0.3s;
        text-align: left; /* å…§å®¹é å·¦ */
    }
    
    /* æ¨™é¡Œå€å¡Š */
    .accordion-header {
        padding: 15px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: background-color 0.2s;
    }
    
    /* æ¨™é¡Œæ–‡å­— */
    .accordion-title {
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        width: 100%;
    }
    
    /* åƒ¹æ ¼æ•¸å­—ç‰¹åˆ¥æ¨£å¼ */
    .accordion-title .price-tag {
        font-size: 18px;
        margin-left: auto;
        color: #1b5e20;
        margin-right: 10px;
    }

    /* å…§å®¹å€å¡Š (é è¨­éš±è—) */
    .accordion-content {
        display: none;
        padding: 0 20px 20px 20px;
        border-top: 1px dashed rgba(0,0,0,0.1);
        font-size: 14px;
        line-height: 1.6;
        color: #555;
    }

    /* å±•é–‹ç‹€æ…‹ */
    .accordion-box.active .accordion-content { display: block; }
    .accordion-box.active .arrow { transform: rotate(180deg); }

    /* ç®­é ­æ¨£å¼ */
    .arrow {
        font-size: 12px;
        transition: transform 0.3s ease;
        opacity: 0.6;
    }

    /* --- ğŸ’° è²»ç”¨ç‰ˆé…è‰² (ç¶ è‰²) --- */
    .accordion-box.price-theme {
        background-color: var(--price-bg);
        border-color: #c8e6c9;
        color: var(--price-text);
    }
    .accordion-box.price-theme .accordion-header:hover {
        background-color: rgba(76, 175, 80, 0.05);
    }
    .price-highlight {
        font-weight: bold;
        color: #1b5e20;
        background: rgba(165, 214, 167, 0.3);
        padding: 0 4px;
        border-radius: 4px;
    }
    .price-example {
        margin-top: 10px;
        font-size: 13px;
        color: #1b5e20;
        background: rgba(255,255,255,0.6);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #a5d6a7;
    }

    /* --- ğŸ“œ è¦ç¯„ç‰ˆé…è‰² (è—ç°è‰²) --- */
    .accordion-box.rules-theme {
        background-color: #eceff1;
        border-color: #cfd8dc;
        color: #455a64;
    }
    .accordion-box.rules-theme .accordion-header:hover {
        background-color: #e0e0e0;
    }

    /* ğŸ“ è¨ªå®¢è³‡æ–™è¼¸å…¥å€ */
    .guest-form {
        background-color: #ffffff;
        padding: 10px 0;
        margin-bottom: 20px;
        text-align: left;
    }
    .form-group { margin-bottom: 15px; }
    
    /* âœï¸ ä¿®æ”¹ï¼šå•é¡Œæ¨™é¡Œå­—é«”åŠ å¤§ (16px) */
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 800;
        color: #2c3e50;
        font-size: 16px;
    }
    
    .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.3s ease;
        background-color: #fafafa;
    }
    .form-group input:focus {
        border-color: var(--evening-light);
        background-color: #fff;
        outline: none;
    }

    /* ğŸ”¥ æ–°å¢ï¼šç…è»Š/è®Šé€Ÿç³»çµ±é¸æ“‡æ¨£å¼ */
    .radio-group {
        display: flex;
        gap: 15px;
    }
    /* âœï¸ ä¿®æ”¹ï¼šé¸é …æŒ‰éˆ•å„ªåŒ– (14px + è®Šçª„) */
    .radio-label {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 10px; /* ä¸Šä¸‹è®Šçª„ */
        background-color: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        font-size: 14px; /* å­—é«” 14px */
        color: #555;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        white-space: nowrap;
    }
    .radio-label:hover {
        border-color: var(--evening-light);
        background-color: #f0fafa;
        transform: translateY(-1px);
    }
    
    /* éš±è—åŸç”Ÿ radio æŒ‰éˆ• */
    .radio-label input[type="radio"] { display: none; }
    
    /* é¸ä¸­ç‹€æ…‹ */
    .radio-label:has(input:checked) {
        border-color: var(--evening-light);
        background-color: var(--evening-bg);
        color: var(--evening-main);
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0, 172, 193, 0.2);
        transform: translateY(-2px);
    }
    /* èˆŠç€è¦½å™¨å…¼å®¹ */
    .radio-label input:checked + span { font-weight: bold; }
    
    /* è¼‰å…¥å‹•ç•« */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.98);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--evening-main);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { margin-top: 15px; font-size: 16px; color: #666; font-weight: 500; }

    /* Modal å½ˆçª—æ¨£å¼ */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 10000; }
    .modal-box { background: white; padding: 30px; border-radius: 24px; text-align: center; max-width: 320px; width: 85%; box-shadow: 0 15px 35px rgba(0,0,0,0.2); animation: modalShow 0.3s ease-out; }
    @keyframes modalShow { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-title { font-size: 20px; font-weight: 800; color: #2c3e50; margin-bottom: 10px; }
    
    .modal-btn { 
        margin-top: 20px; padding: 12px 0; border-radius: 50px; border: none; 
        background: var(--evening-main); color: white; font-weight: bold; cursor: pointer; 
        width: 50%; min-width: 120px; display: block; margin-left: auto; margin-right: auto;
        font-size: 16px; transition: background 0.2s; 
    }
    .modal-btn:hover { background: var(--evening-light); }

    .btn-red { background-color: #ff5252 !important; width: 100% !important; min-width: auto !important; }
    .btn-gray { background-color: #eee !important; color: #333 !important; width: 100% !important; min-width: auto !important; }

    /* æ—¥æ›†æ¨£å¼ */
    .month-title {
      font-weight: 800;
      font-size: 20px;
      margin: 1.5em 0 0.8em;
      color: #37474f;
    }
    .calendar-header, .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 0;
      box-sizing: border-box;
      max-width: 100%;
    }
    .weekday-header {
      font-weight: bold;
      font-size: 13px;
      text-align: center;
      color: #b0bec5;
      padding-bottom: 8px; 
    }
    .day {
      aspect-ratio: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px; 
      background-color: #f7f9fa;
      color: #cfd8dc;
      cursor: default;
      box-sizing: border-box;
      transition: all 0.1s;
      position: relative;
    }
    .day-number { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
    .day-label { font-size: 10px; margin-top: 0px; font-weight: normal; }

    /* === æ™šç­æ¨£å¼ (è—è‰²) === */
    .day.available.evening {
      background-color: #fff;
      color: #333;
      border: 2px solid var(--evening-main);
      cursor: pointer;
    }
    .day.available.evening .day-label { color: var(--evening-main); font-weight: 800; }
    
    .day.selected.evening {
      background-color: var(--evening-main);
      color: #fff;
      border-color: var(--evening-main);
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(0, 131, 143, 0.4);
    }
    .day.selected.evening .day-label { color: #fff; }

    /* === æ—©ç­æ¨£å¼ (é»ƒè‰²) === */
    .day.available.morning {
      background-color: #fff;
      color: #333;
      border: 2px solid var(--morning-main);
      cursor: pointer;
    }
    .day.available.morning .day-label { color: var(--morning-main); font-weight: 800; }

    .day.selected.morning {
      background-color: var(--morning-main);
      color: #fff;
      border-color: var(--morning-main);
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(255, 179, 0, 0.4);
    }
    .day.selected.morning .day-label { color: #fff; }
    
    /* èª¿æ•´æ™‚é™å…§æ¨£å¼ */
    .day.registered.can-cancel.evening { 
        background-color: #e0f2f1 !important; 
        border: 2px solid var(--evening-main) !important; 
        color: var(--evening-main) !important; 
        cursor: pointer !important; 
    }
    .day.registered.can-cancel.morning { 
        background-color: #fff8e1 !important; 
        border: 2px solid var(--morning-main) !important; 
        color: var(--morning-main) !important; 
        cursor: pointer !important; 
    }
    
    .day.registered {
        background-color: #eceff1;
        color: #b0bec5;
        border: 2px solid #cfd8dc; 
        cursor: not-allowed;
    }
    .day.registered .day-label { color: #b0bec5; }

    .day.full {
      background-color: #f5f5f5;
      color: #bdbdbd;
      cursor: not-allowed;
      border: 1px dashed #e0e0e0;
    }
    .day.full .full-label { font-size: 10px; color: #bdbdbd; margin-top: 2px;}

    /* é€å‡ºæŒ‰éˆ• */
    #submit-btn {
      margin: 20px auto 10px; 
      padding: 14px 0;
      font-size: 18px;
      letter-spacing: 1px;
      background: #cfd8dc;
      color: #fff;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      transition: all 0.3s;
    }
    #submit-btn:disabled { cursor: not-allowed; }

    @media (max-width: 600px) {
      body { align-items: flex-start; background: #fff; } 
      .container { margin: 0; padding: 20px; box-shadow: none; border-radius: 0; }
      h1 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div id="cancel-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="cancel-modal-title">èª¿æ•´ç™»è¨˜</div>
        <div id="cancel-modal-msg" style="color: #444; font-size: 16px; line-height: 1.8; margin: 15px 0;"></div>
        <div id="cancel-modal-footer" style="display: flex; gap: 10px; justify-content: center;">
          <button class="modal-btn btn-gray" onclick="closeCancelModal()">å…ˆä¸è¦</button>
          <button class="modal-btn btn-red" id="confirm-cancel-btn">å–æ¶ˆç™»è¨˜</button>
        </div>
        <button id="cancel-close-btn" class="modal-btn" style="display:none;" onclick="closeCancelModal()">ç¢ºå®š</button>
    </div>
  </div>

  <div id="alert-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="alert-title">æç¤º</div>
        <div id="alert-msg" style="color: #444; font-size: 16px; line-height: 1.6; margin: 15px 0;"></div>
        <button class="modal-btn" id="alert-btn">ç¢ºå®š</button>
    </div>
  </div>

  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">è¼‰å…¥èª²ç¨‹è³‡è¨Š...</div>
  </div>

  <div class="container">
    
    <img src="logo_icon.png" alt="å…‰è¿ Logo" class="main-logo">

    <h1>å…‰è¿å–®å ‚åŠŸç‡é«”é©—</h1>
    
    <div class="schedule-box">
        <div class="schedule-row">
            <span class="time-badge badge-evening">æ™šç­</span> é€±äºŒ / é€±å›› 19:30ï½21:00
        </div>
        <div class="schedule-row">
            <span class="time-badge badge-morning">æ—©ç­</span> é€±ä¸‰ 06:30ï½08:00
        </div>
    </div>
    
    <div class="accordion-box price-theme">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                å–®å ‚é«”é©—è²»ç”¨ <span class="price-tag">$660</span>
            </div>
            <span class="arrow">â–¼</span>
        </div>
        <div class="accordion-content">
            <div style="margin-top: 15px;">
                ğŸ’¡ <strong>è³¼èª²æŠ˜æŠµå„ªæƒ ï¼š</strong><br><br>
                è‹¥å¾ŒçºŒè³¼è²·æ­£å¼èª²å¡ï¼ˆ10å ‚/20å ‚ï¼‰ï¼Œæœ¬å ‚é«”é©—è²» <span class="price-highlight">å¯å…¨é¡æŠ˜æŠµ</span>ã€‚<br><br>
                <div class="price-example">
                    ä¾‹å¦‚ï¼šè³¼è²· 10 å ‚èª²æ–¹æ¡ˆ ($5500)<br>
                    æ‰£é™¤å·²ä»˜ $660ï¼Œ<strong>åƒ…éœ€è£œå·®é¡ $4840</strong><br>
                    å³äº«å®Œæ•´ 10 å ‚å„ªæƒ  <span style="color:#2e7d32">ï¼ˆå«æœ¬æ¬¡é«”é©—ï¼Œå‰©é¤˜ 9 å ‚ï¼‰</span>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion-box rules-theme">
        <div class="accordion-header" onclick="toggleAccordion(this)">
            <div class="accordion-title">
                èª²å ‚è¦ç¯„ <span style="font-size: 14px; font-weight: normal; margin-left: 10px; opacity: 0.7;">(åˆæ¬¡è«‹è©³é–±)</span>
            </div>
            <span class="arrow">â–¼</span>
        </div>
        <div class="accordion-content">
            <div style="margin-top: 15px; font-size: 15px; line-height: 1.8;">
                <p style="margin: 0 0 10px;">ãƒ»è«‹ç©¿è‘—è»Šè¤²ã€è»Šè¡£ï¼ˆæˆ–é‹å‹•ä¸Šè¡£ï¼‰ã€‚</p>
                
                <strong style="color: #2c3e50;">è«‹æ”œå¸¶ï¼š</strong>
                <ul style="padding-left: 20px; margin: 5px 0 15px; list-style-type: none;">
                    <li>- è‡ªè¡Œè»Š</li>
                    <li>- æ¯›å·¾</li>
                    <li>- æ°´å£º</li>
                    <li>- å¿ƒè·³å¸¶ï¼ˆé¸é…ï¼‰</li>
                    <li>- å¡é‹ï¼ˆé¸é…ï¼‰</li>
                </ul>

                <p style="margin: 0 0 5px;">ãƒ»è«‹ææ—©10åˆ†é˜æŠµé”ï¼Œä»¥åˆ©ç³»çµ±è¨­å®šã€‚</p>
                <p style="margin: 0 0 5px;">ãƒ»è‹¥æœ‰å¿ƒè¡€ç®¡ç–¾ç—…æˆ–èº«é«”ä¸é©ï¼Œè«‹å‘ŠçŸ¥æ•™ç·´ã€‚</p>
                <p style="margin: 0;">ãƒ»å¦‚éœ€è®Šæ›´æ™‚æ®µï¼Œè«‹æ–¼èª²å‰12å°æ™‚è¯ç¹«æ•™ç·´ã€‚</p>
            </div>
        </div>
    </div>

    <div class="guest-form">
        <div class="form-group">
            <label>çœŸå¯¦å§“å</label>
            <input type="text" id="guest-name" placeholder="è«‹è¼¸å…¥å§“å" required>
        </div>
        <div class="form-group">
            <label>è¯çµ¡é›»è©±</label>
            <input type="tel" id="guest-phone" placeholder="09xxxxxxxx" required>
        </div>
        <div class="form-group">
            <label>Email (æ¥æ”¶æ—¥æ›†é‚€è«‹)</label>
            <input type="email" id="guest-email" placeholder="example@gmail.com" required>
        </div>
        
        <div class="form-group">
            <label>è‡ªè¡Œè»Šç…è»Šç³»çµ±</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="brake-system" value="æ¡†ç…">
                    <span>æ¡†ç… (Cå¤¾)</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="brake-system" value="ç¢Ÿç…">
                    <span>ç¢Ÿç… (Disc)</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>è®Šé€Ÿ</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="gear-system" value="11é€Ÿ">
                    <span>11é€Ÿ</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="gear-system" value="12é€Ÿ">
                    <span>12é€Ÿ</span>
                </label>
                <label class="radio-label" style="min-width: 140px;">
                    <input type="radio" name="gear-system" value="other" id="gear-other-radio">
                    <span>å…¶ä»–ï¼š</span>
                    <input type="text" id="gear-other-text" placeholder="è«‹å¡«å¯«" 
                           style="width: 70px; margin-left: 5px; border: none; border-bottom: 1px solid #ccc; background: transparent; font-size: 15px; padding: 2px; color: #333; height: auto;"
                           onfocus="document.getElementById('gear-other-radio').checked = true;">
                </label>
            </div>
        </div>
    </div>

    <div id="calendar"></div>
    <button id="submit-btn" disabled>è«‹å…ˆé¸æ“‡æ—¥æœŸ</button>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ è«‹ç¢ºèªæ‚¨çš„ GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaAiWuCchIr3I4cpPD0GzWqgE9AW4MEXYuPKOFOldl3mQE1WxjCECssLVetJC5Wb-O/exec";

    // åˆ‡æ›æŠ˜ç–Šç‹€æ…‹
    function toggleAccordion(element) {
        const box = element.parentElement;
        box.classList.toggle('active');
    }

    let selectedDate = null; 
    let selectedType = ""; 
    let countdownInterval = null;

    // ğŸ”¥ å¾ LocalStorage è®€å–å·²å ±åè³‡æ–™ (é«”é©—èª²å°ˆç”¨)
    let myTrialSignups = JSON.parse(localStorage.getItem('myTrialSignups')) || [];

    function closeCancelModal() { document.getElementById('cancel-modal').style.display = 'none'; if (countdownInterval) clearInterval(countdownInterval); }

    function showSystemAlert(title, message, callback) {
        document.getElementById('alert-title').textContent = title;
        document.getElementById('alert-msg').innerHTML = message;
        
        const btn = document.getElementById('alert-btn');
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.onclick = () => {
             document.getElementById('alert-modal').style.display = 'none';
             if (callback) callback();
        };
        document.getElementById('alert-modal').style.display = 'flex';
    }

    async function loadData() {
      try {
        const res = await fetch(`${SCRIPT_URL}?mode=powerAllData&courseType=evening`);
        const data = await res.json();
        return data;
      } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
        alert('ç„¡æ³•é€£çµä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦');
        return null;
      }
    }

    async function renderCalendar() {
      const calendarDiv = document.getElementById('calendar');
      const loadingDiv = document.getElementById('loading');
      
      loadingDiv.style.display = 'flex';
      calendarDiv.innerHTML = '';

      const allData = await loadData();
      loadingDiv.style.display = 'none';

      if (!allData || !allData.dates || allData.dates.length === 0) {
        calendarDiv.innerHTML = '<div style="color:red; font-size: 1.2em; margin-top: 20px;">âš ï¸ ç›®å‰ç„¡å¯é ç´„æ™‚æ®µ</div>';
        return;
      }

      const availableDates = allData.dates;
      const signupCounts = allData.counts || {};
      const availableSet = new Set(availableDates);
      const nowTs = new Date().getTime();

      const start = new Date(availableDates[0]);
      const end = new Date(availableDates[availableDates.length - 1]);

      for (let y = start.getFullYear(); y <= end.getFullYear(); y++) {
        for (let m = 0; m < 12; m++) {
          const first = new Date(y, m, 1);
          const last = new Date(y, m + 1, 0);
          
          if (last < start || first > end) continue; 
          
          const title = document.createElement('div');
          title.className = 'month-title';
          title.textContent = `${y}å¹´${m + 1}æœˆ`;
          calendarDiv.appendChild(title);

          const header = document.createElement('div');
          header.className = 'calendar-header';
          ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => {
            const h = document.createElement('div');
            h.className = 'weekday-header';
            h.textContent = d;
            header.appendChild(h);
          });
          calendarDiv.appendChild(header);

          const grid = document.createElement('div');
          grid.className = 'calendar-grid';

          for (let i = 0; i < first.getDay(); i++) {
            grid.appendChild(document.createElement('div'));
          }

          for (let d = 1; d <= last.getDate(); d++) {
            const dateStr = `${y}/${String(m + 1).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
            const cell = document.createElement('div');
            cell.className = 'day';
            
            const numSpan = document.createElement('span');
            numSpan.className = 'day-number';
            numSpan.textContent = d;
            cell.appendChild(numSpan);

            const dayOfWeek = new Date(dateStr).getDay();
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºã€Œæœ¬æ©Ÿå·²å ±åã€
            const myRecord = myTrialSignups.find(r => r.date === dateStr);

            if (myRecord) {
                const diff = nowTs - myRecord.timestamp;
                // 10åˆ†é˜å…§å¯å–æ¶ˆ
                if (diff <= 600000) {
                    const theme = (dayOfWeek === 3) ? 'morning' : 'evening';
                    cell.classList.add('registered', 'can-cancel', theme);
                    
                    const label = document.createElement('div');
                    label.className = 'day-label';
                    label.textContent = "å·²ç™»è¨˜";
                    cell.appendChild(label);

                    cell.onclick = () => {
                        const updateCancelModal = () => {
                          const now = new Date().getTime();
                          const remainMs = 600000 - (now - myRecord.timestamp);
                          const msgEl = document.getElementById('cancel-modal-msg'), titleEl = document.getElementById('cancel-modal-title');
                          const footer = document.getElementById('cancel-modal-footer'), closeBtn = document.getElementById('cancel-close-btn');
                          if (remainMs > 0) {
                            const mins = Math.floor(remainMs / 60000), secs = Math.floor((remainMs % 60000) / 1000);
                            titleEl.textContent = "å–æ¶ˆç™»è¨˜";
                            msgEl.innerHTML = `æ‚¨å·²ç™»è¨˜ ${dateStr} é«”é©—èª²ã€‚<br>é‚„æœ‰ <b style="font-size: 22px; color: var(--cancel-gold);">${mins} åˆ† ${secs.toString().padStart(2, '0')} ç§’</b> å¯ä»¥å–æ¶ˆç™»è¨˜å–”ï¼`;
                            footer.style.display = 'flex'; closeBtn.style.display = 'none';
                            document.getElementById('confirm-cancel-btn').onclick = () => { closeCancelModal(); handleCancel(dateStr, myRecord.lineId); };
                          } else {
                            if (countdownInterval) clearInterval(countdownInterval);
                            titleEl.textContent = "èª²ç¨‹å·²å®Œæˆç™»è¨˜ï¼"; msgEl.innerHTML = `å¦‚éœ€è«‹å‡ï¼Œè«‹ç›´æ¥ç§è¨Šæ•™ç·´ã€‚`;
                            footer.style.display = 'none'; closeBtn.style.display = 'block';
                          }
                          document.getElementById('cancel-modal').style.display = 'flex';
                        };
                        updateCancelModal(); if (countdownInterval) clearInterval(countdownInterval);
                        countdownInterval = setInterval(updateCancelModal, 1000);
                    };
                } else {
                    cell.classList.add('registered');
                    const label = document.createElement('div');
                    label.className = 'day-label';
                    label.textContent = "å·²ç™»è¨˜";
                    cell.appendChild(label);
                }

            } else if (availableSet.has(dateStr)) {
                let currentCount = 0;
                let labelText = "";
                let type = "";
                let themeClass = ""; 

                if (dayOfWeek === 3) { 
                    type = "morning"; 
                    currentCount = signupCounts[dateStr] ? (signupCounts[dateStr].morning || 0) : 0;
                    labelText = "06:30";
                    themeClass = "morning";
                } else if (dayOfWeek === 2 || dayOfWeek === 4) { 
                    type = "evening";
                    currentCount = signupCounts[dateStr] ? (signupCounts[dateStr].evening || 0) : 0;
                    labelText = "19:30";
                    themeClass = "evening";
                }

                const isFull = currentCount >= 6; 

                if (isFull) {
                    cell.classList.add('full');
                    const fullLabel = document.createElement('div');
                    fullLabel.className = 'full-label';
                    fullLabel.textContent = "é¡æ»¿";
                    cell.appendChild(fullLabel);
                } else {
                    cell.classList.add('available');
                    cell.classList.add(themeClass); 
                    
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'day-label';
                    timeLabel.textContent = labelText;
                    cell.appendChild(timeLabel);

                    cell.onclick = () => {
                        handleSelection(cell, dateStr, type, themeClass);
                    };
                }
            }

            grid.appendChild(cell);
          }
          calendarDiv.appendChild(grid);
        }
      }
    }

    // å–æ¶ˆå‡½å¼ (Trial å°ˆç”¨)
    async function handleCancel(dateStr, fakeLineId) {
      const loadingDiv = document.getElementById('loading');
      loadingDiv.style.display = 'flex';
      document.querySelector('.loading-text').textContent = "æ­£åœ¨å–æ¶ˆç™»è¨˜...";
      
      try {
        const res = await fetch(`${SCRIPT_URL}?mode=cancel&date=${encodeURIComponent(dateStr)}&lineId=${encodeURIComponent(fakeLineId)}`);
        const data = await res.json();
        
        loadingDiv.style.display = 'none';

        if (data.status === 'success') {
             // ç§»é™¤ LocalStorage ç´€éŒ„
             myTrialSignups = myTrialSignups.filter(r => r.date !== dateStr);
             localStorage.setItem('myTrialSignups', JSON.stringify(myTrialSignups));
             
             showSystemAlert('å–æ¶ˆæˆåŠŸï¼', '', () => { location.reload(); });
        } else {
             showSystemAlert('æç¤º', data.message, () => { location.reload(); });
        }

      } catch (e) { 
        loadingDiv.style.display = 'none';
        showSystemAlert("é€£ç·šéŒ¯èª¤", "ç³»çµ±é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", null);
      }
    }

    function handleSelection(cell, dateStr, type, themeClass) {
        const btn = document.getElementById('submit-btn');

        if (selectedDate === dateStr) {
            selectedDate = null;
            selectedType = "";
            cell.classList.remove('selected');
            
            btn.style.backgroundColor = '#cfd8dc';
            btn.textContent = "è«‹å…ˆé¸æ“‡æ—¥æœŸ";
            btn.style.boxShadow = 'none';
            btn.disabled = true;
        } else {
            document.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
            
            selectedDate = dateStr;
            selectedType = type;
            cell.classList.add('selected');

            btn.disabled = false;
            btn.textContent = "ç¢ºèªé ç´„";
            
            if (themeClass === 'morning') {
                btn.style.backgroundColor = '#ffca28'; 
                btn.style.boxShadow = '0 4px 15px rgba(255, 202, 40, 0.4)';
            } else {
                btn.style.backgroundColor = '#00acc1'; 
                btn.style.boxShadow = '0 4px 15px rgba(0, 172, 193, 0.4)';
            }
        }
    }

    document.getElementById('submit-btn').addEventListener('click', async () => {
        let name = document.getElementById('guest-name').value.trim();
        const phone = document.getElementById('guest-phone').value.trim();
        const email = document.getElementById('guest-email').value.trim();
        
        // 1. ç²å–ç…è»Šç³»çµ±
        const brakeEl = document.querySelector('input[name="brake-system"]:checked');
        const brake = brakeEl ? brakeEl.value : "";

        // 2. ğŸ”¥ ç²å–è®Šé€Ÿç³»çµ±
        const gearEl = document.querySelector('input[name="gear-system"]:checked');
        let gear = "";
        if (gearEl) {
            if (gearEl.value === "other") {
                const otherText = document.getElementById('gear-other-text').value.trim();
                if (!otherText) {
                    showSystemAlert('æç¤º', 'è«‹å¡«å¯«ã€Œå…¶ä»–ã€è®Šé€Ÿç³»çµ±çš„è©³ç´°è³‡è¨Š');
                    return;
                }
                gear = otherText;
            } else {
                gear = gearEl.value;
            }
        }

        // ğŸ›¡ï¸ é˜²å‘†ï¼šæª¢æŸ¥æ¬„ä½æ˜¯å¦ç‚ºç©º (brake å’Œ gear ä¹Ÿå¿…é ˆæœ‰å€¼)
        if (!name || !phone || !email || !brake || !gear) {
            showSystemAlert('æç¤º', 'è«‹å®Œæ•´å¡«å¯«ï¼šå§“åã€é›»è©±ã€Emailã€ç…è»Šèˆ‡è®Šé€Ÿç³»çµ±');
            return;
        }

        // ğŸ¯ æ ¼å¼é©—è­‰
        const phoneReg = /^09\d{8}$/;
        if (!phoneReg.test(phone)) {
            showSystemAlert('æ ¼å¼éŒ¯èª¤', 'æ‰‹æ©Ÿè™Ÿç¢¼è«‹è¼¸å…¥ 09 é–‹é ­çš„ 10 ä½æ•¸å­—ã€‚');
            return;
        }
        const emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailReg.test(email)) {
            showSystemAlert('æ ¼å¼éŒ¯èª¤', 'è«‹å¡«å¯«æ­£ç¢ºçš„ Email åœ°å€ï¼Œä»¥ä¾¿æ¥æ”¶æ—¥æ›†é‚€è«‹ã€‚');
            return;
        }

        if (!selectedDate) {
            showSystemAlert('æç¤º', 'è«‹é»é¸ä¸€å€‹é ç´„æ—¥æœŸ');
            return;
        }

        let timeInfo = selectedType === "morning" ? "æ—©ç­ 06:30" : "æ™šç­ 19:30";
        
        // ğŸ”¥ å°‡ç…è»Šèˆ‡è®Šé€Ÿé¡¯ç¤ºåœ¨ç¢ºèªè¦–çª—ï¼Œä½†è³‡æ–™æ˜¯ç¨ç«‹å‚³é€çš„ (å§“åä¿æŒä¹¾æ·¨)
        const confirmMsg = `ã€é ç´„ç¢ºèªã€‘\n\næ—¥æœŸï¼š${selectedDate}\næ™‚æ®µï¼š${timeInfo}\nå§“åï¼š${name}\né›»è©±ï¼š${phone}\nè¦æ ¼ï¼š${brake} / ${gear}\nè²»ç”¨ï¼š$660\n\nâ€» è¦ç¯„æé†’ï¼š\n1. é ç´„å¾Œè«‹æ–¼ 24 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ã€‚\n2. åŒ¯æ¬¾å¾Œè«‹ç§è¨Šã€Œå…‰è¿å·¥ä½œå®¤ã€å‘ŠçŸ¥å¾Œäº”ç¢¼ä»¥ä¿ç•™å¸­ä½ã€‚\n3. è‹¥ç„¡æ•…ç¼ºå¸­ï¼Œè²»ç”¨å°‡ä¸äºˆé€€é‚„ã€‚\n\nç¢ºèªé€å‡ºï¼Ÿ`;

        if (!confirm(confirmMsg)) {
            return;
        }

        const loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = 'flex';
        document.querySelector('.loading-text').textContent = "æ­£åœ¨é ç´„ä¸­...";
        
        try {
            const params = new URLSearchParams({
                mode: 'trial_submit',
                date: selectedDate,
                name: name,   // å§“åç¶­æŒç´”æ·¨
                phone: phone,
                email: email,
                brake: brake, // ç¨ç«‹å‚³é€
                gear: gear    // ç¨ç«‹å‚³é€
            });

            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();

            loadingDiv.style.display = 'none';

            if (result.status === 'success') {
                const fakeLineId = "TRIAL_" + phone;
                myTrialSignups.push({
                    date: selectedDate,
                    lineId: fakeLineId,
                    timestamp: new Date().getTime()
                });
                localStorage.setItem('myTrialSignups', JSON.stringify(myTrialSignups));

                const successMsg = `é ç´„æˆåŠŸï¼ç³»çµ±å·²ç™¼é€ Google Calendar é‚€è«‹è‡³æ‚¨çš„ Emailã€‚<br><br><b>ã€ä¸‹ä¸€æ­¥ï¼šä¿ç•™å¸­ä½ã€‘</b><br>è«‹åŒ¯æ¬¾è‡³ï¼š<b>ä¸­åœ‹ä¿¡è¨— (822) XXXXXXXXX</b><br>é‡‘é¡ï¼š<b>$660</b><br><br>å®Œæˆå¾Œè«‹ç§è¨Šå‘ŠçŸ¥å¾Œäº”ç¢¼ï¼Œå‡¡å‡¡æ•™ç·´å°‡ç‚ºæ‚¨æ­£å¼ç¢ºèªã€‚`;
                
                showSystemAlert('é ç´„æˆåŠŸ', successMsg, () => { location.reload(); });
            } else {
                showSystemAlert('é ç´„å¤±æ•—', result.message);
            }

        } catch (error) {
            console.error(error);
            loadingDiv.style.display = 'none';
            showSystemAlert('éŒ¯èª¤', 'ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
    });

    renderCalendar();
  </script>
</body>
</html>
