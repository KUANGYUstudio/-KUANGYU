<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…‰è¿å–®å ‚åŠŸç‡é«”é©—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* =========================================
       ğŸ¨ é…è‰²å®šç¾© (è³ªæ„Ÿå‡ç´šç‰ˆ)
       ========================================= */
    :root {
      /* æ™šç­ - å°ˆæ¥­è— (ç¨å¾®åŠ æ·±ä¸€é»é»ï¼Œæ›´æœ‰è³ªæ„Ÿ) */
      --evening-main: #00acc1; 
      --evening-bg: #e0f7fa;
      --evening-border: #00acc1;
      
      /* æ—©ç­ - æ´»åŠ›é»ƒ (ç¶­æŒæ˜äº®) */
      --morning-main: #ffca28;
      --morning-bg: #fff8e1;
      --morning-border: #ffca28;

      /* æé†’å€å¡Š - æº«æŸ”ç° */
      --note-text: #546e7a;
      --note-bg: #f5f5f5;
    }

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px 20px;
      box-sizing: border-box;
      text-align: center;
    }
    h1 {
      font-size: 32px;
      margin: 0 0 0.5em;
      color: #2c3e50;
      font-weight: 800;
      letter-spacing: 1px;
    }
    .info {
      font-size: 18px;
      color: #555;
      margin-bottom: 1em;
      line-height: 2;
    }
    
    /* === ğŸ·ï¸ å„ªåŒ–å¾Œçš„èª²ç¨‹æ¨™ç±¤ === */
    .time-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 15px;
        margin: 0 6px;
        font-weight: bold;
        color: white;
        vertical-align: middle;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* å¾®å¾®çš„é™°å½±è®“å®ƒæµ®èµ·ä¾† */
    }
    .badge-morning { 
        background-color: var(--morning-main); 
        color: #fff; 
        text-shadow: 0 1px 1px rgba(0,0,0,0.1); 
    }
    .badge-evening { 
        background-color: var(--evening-main); 
    }

    /* === ğŸ’¡ æº«é¦¨æé†’å€å¡Š (å»è­¦ç¤ºåŒ–) === */
    .sub-info {
        font-size: 15px; 
        color: var(--note-text);
        margin-bottom: 30px;
        background: var(--note-bg);
        display: inline-block;
        padding: 10px 20px;
        border-radius: 50px; /* è† å›Šç‹€ */
        margin-top: 10px;
        border: 1px solid #e0e0e0; /* æ¥µç´°é‚Šæ¡†å¢åŠ ç²¾ç·»æ„Ÿ */
    }

    /* ğŸ“ è¨ªå®¢è³‡æ–™è¼¸å…¥å€ */
    .guest-form {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 16px;
        margin-bottom: 30px;
        text-align: left;
        max-width: 480px;
        margin-left: auto;
        margin-right: auto;
        /* æ”¹ç”¨æ›´æŸ”å’Œçš„é™°å½± */
        box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        border: 1px solid #f0f0f0;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #455a64;
        font-size: 15px;
    }
    .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #eee; /* é è¨­é‚Šæ¡†æ·¡ä¸€é» */
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.3s ease;
        background-color: #fafafa;
    }
    .form-group input:focus {
        border-color: var(--evening-main);
        background-color: #fff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 172, 193, 0.1);
    }
    
    /* è¼‰å…¥å‹•ç•« */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.98);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--evening-main);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 15px;
      font-size: 16px;
      color: #666;
      font-weight: 500;
    }

    /* æ—¥æ›†æ¨£å¼ */
    .month-title {
      font-weight: 800;
      font-size: 22px;
      margin: 1.5em 0 1em;
      color: #37474f;
      letter-spacing: 1px;
    }
    .calendar-header, .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px; /* æ ¼å­é–“è·åŠ å¤§ä¸€é»é» */
      padding: 0;
      box-sizing: border-box;
      max-width: 100%;
    }
    .weekday-header {
      font-weight: bold;
      font-size: 14px;
      text-align: center;
      color: #b0bec5;
      padding-bottom: 10px; 
    }
    .day {
      aspect-ratio: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 12px; 
      background-color: #f7f9fa; /* é è¨­èƒŒæ™¯æ›´ä¹¾æ·¨ */
      color: #cfd8dc;
      cursor: default;
      box-sizing: border-box;
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
    }
    .day-number { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
    .day-label { font-size: 10px; margin-top: 0px; font-weight: normal; }

    /* === æ™šç­æ¨£å¼ (è—è‰²) === */
    .day.available.evening {
      background-color: #fff; /* ç™½åº•æ›´æ¸…çˆ½ */
      color: #333;
      border: 2px solid var(--evening-bg); /* ç”¨æ·ºè—è‰²æ¡† */
      cursor: pointer;
    }
    .day.available.evening .day-label { color: var(--evening-main); font-weight: bold; }
    
    .day.selected.evening {
      background-color: var(--evening-main);
      color: #fff;
      border-color: var(--evening-main);
      transform: translateY(-3px); /* é¸ä¸­æ™‚å¾®å¾®ä¸Šæµ® */
      box-shadow: 0 5px 15px rgba(0, 172, 193, 0.3);
    }
    .day.selected.evening .day-label { color: #fff; }

    /* === æ—©ç­æ¨£å¼ (é»ƒè‰²) === */
    .day.available.morning {
      background-color: #fff;
      color: #333;
      border: 2px solid var(--morning-bg);
      cursor: pointer;
    }
    .day.available.morning .day-label { color: #fbc02d; font-weight: bold; } /* ç¨å¾®æ·±ä¸€é»çš„é»ƒå­—æ‰çœ‹å¾—æ¸…æ¥š */

    .day.selected.morning {
      background-color: var(--morning-main);
      color: #fff;
      border-color: var(--morning-main);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(255, 202, 40, 0.4);
    }
    .day.selected.morning .day-label { color: #fff; }
    
    /* é¡æ»¿ç‹€æ…‹ */
    .day.full {
      background-color: #f5f5f5;
      color: #bdbdbd;
      cursor: not-allowed;
      border: 1px dashed #e0e0e0; /* è™›ç·šæ¡†ä»£è¡¨ç„¡æ•ˆ */
    }
    .day.full .full-label { font-size: 10px; color: #bdbdbd; margin-top: 2px;}

    /* é€å‡ºæŒ‰éˆ• */
    #submit-btn {
      margin: 30px auto 50px; 
      padding: 16px 0;
      font-size: 18px;
      letter-spacing: 1px;
      background: #cfd8dc; /* æœªé¸æ™‚ç‚ºè³ªæ„Ÿç° */
      color: #fff;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      max-width: 320px;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: none;
    }
    #submit-btn:disabled {
        cursor: not-allowed;
    }

    @media (max-width: 750px) {
      h1 { font-size: 26px; }
      .guest-form { padding: 25px 20px; margin-bottom: 20px; }
      .container { padding: 20px 15px; }
      .calendar-header, .calendar-grid { gap: 6px; }
      .day { border-radius: 10px; }
      .day-number { font-size: 16px; }
      .day-label { font-size: 9px; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">è¼‰å…¥èª²ç¨‹è³‡è¨Š...</div>
  </div>

  <div class="container">
    <h1>å…‰è¿å–®å ‚åŠŸç‡é«”é©—</h1>
    <div class="info">
        <span class="time-badge badge-evening">æ™šç­ (è—)</span> é€±äºŒ / é€±å›› 19:30ï½21:00<br>
        <div style="height: 8px;"></div> <span class="time-badge badge-morning">æ—©ç­ (é»ƒ)</span> é€±ä¸‰ 06:30ï½08:00
    </div>
    
    <div class="sub-info">ğŸ’¡ è²¼å¿ƒæé†’ï¼šæ¯äººé™é ç´„ä¸€å ‚é«”é©—èª²</div>

    <div class="guest-form">
        <div class="form-group">
            <label>çœŸå¯¦å§“å</label>
            <input type="text" id="guest-name" placeholder="è«‹è¼¸å…¥å§“å" required>
        </div>
        <div class="form-group">
            <label>è¯çµ¡é›»è©± (é ç´„ä»£ç¢¼)</label>
            <input type="tel" id="guest-phone" placeholder="09xxxxxxxx" required>
        </div>
        <div class="form-group">
            <label>Email (æ¥æ”¶æ—¥æ›†é‚€è«‹)</label>
            <input type="email" id="guest-email" placeholder="example@gmail.com" required>
        </div>
    </div>

    <div id="calendar"></div>
    <button id="submit-btn" disabled>è«‹å…ˆé¸æ“‡æ—¥æœŸ</button>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ è«‹ç¢ºèªé€™è£¡æ˜¯ä½ æœ€æ–°çš„ GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaAiWuCchIr3I4cpPD0GzWqgE9AW4MEXYuPKOFOldl3mQE1WxjCECssLVetJC5Wb-O/exec";

    let selectedDate = null; 
    let selectedType = ""; 

    async function loadData() {
      try {
        const res = await fetch(`${SCRIPT_URL}?mode=powerAllData&courseType=evening`);
        const data = await res.json();
        return data;
      } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
        alert('ç„¡æ³•é€£çµä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦');
        return null;
      }
    }

    async function renderCalendar() {
      const calendarDiv = document.getElementById('calendar');
      const loadingDiv = document.getElementById('loading');
      
      loadingDiv.style.display = 'flex';
      calendarDiv.innerHTML = '';

      const allData = await loadData();
      loadingDiv.style.display = 'none';

      if (!allData || !allData.dates || allData.dates.length === 0) {
        calendarDiv.innerHTML = '<div style="color:red; font-size: 1.2em; margin-top: 20px;">âš ï¸ ç›®å‰ç„¡å¯é ç´„æ™‚æ®µ</div>';
        return;
      }

      const availableDates = allData.dates;
      const signupCounts = allData.counts || {};
      const availableSet = new Set(availableDates);

      const start = new Date(availableDates[0]);
      const end = new Date(availableDates[availableDates.length - 1]);

      for (let y = start.getFullYear(); y <= end.getFullYear(); y++) {
        for (let m = 0; m < 12; m++) {
          const first = new Date(y, m, 1);
          const last = new Date(y, m + 1, 0);
          
          if (last < start || first > end) continue; 
          
          const title = document.createElement('div');
          title.className = 'month-title';
          title.textContent = `${y}å¹´${m + 1}æœˆ`;
          calendarDiv.appendChild(title);

          const header = document.createElement('div');
          header.className = 'calendar-header';
          ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => {
            const h = document.createElement('div');
            h.className = 'weekday-header';
            h.textContent = d;
            header.appendChild(h);
          });
          calendarDiv.appendChild(header);

          const grid = document.createElement('div');
          grid.className = 'calendar-grid';

          for (let i = 0; i < first.getDay(); i++) {
            grid.appendChild(document.createElement('div'));
          }

          for (let d = 1; d <= last.getDate(); d++) {
            const dateStr = `${y}/${String(m + 1).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
            const cell = document.createElement('div');
            cell.className = 'day';
            
            const numSpan = document.createElement('span');
            numSpan.className = 'day-number';
            numSpan.textContent = d;
            cell.appendChild(numSpan);

            const dayOfWeek = new Date(dateStr).getDay();
            
            if (availableSet.has(dateStr)) {
                let currentCount = 0;
                let labelText = "";
                let type = "";
                let themeClass = ""; 

                if (dayOfWeek === 3) { 
                    type = "morning"; 
                    currentCount = signupCounts[dateStr] ? (signupCounts[dateStr].morning || 0) : 0;
                    labelText = "06:30";
                    themeClass = "morning";
                } else if (dayOfWeek === 2 || dayOfWeek === 4) { 
                    type = "evening";
                    currentCount = signupCounts[dateStr] ? (signupCounts[dateStr].evening || 0) : 0;
                    labelText = "19:30";
                    themeClass = "evening";
                }

                const isFull = currentCount >= 6; 

                if (isFull) {
                    cell.classList.add('full');
                    const fullLabel = document.createElement('div');
                    fullLabel.className = 'full-label';
                    fullLabel.textContent = "é¡æ»¿";
                    cell.appendChild(fullLabel);
                } else {
                    cell.classList.add('available');
                    cell.classList.add(themeClass); 
                    
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'day-label';
                    timeLabel.textContent = labelText;
                    cell.appendChild(timeLabel);

                    cell.onclick = () => {
                        handleSelection(cell, dateStr, type, themeClass);
                    };
                }
            }

            grid.appendChild(cell);
          }
          calendarDiv.appendChild(grid);
        }
      }
    }

    function handleSelection(cell, dateStr, type, themeClass) {
        const btn = document.getElementById('submit-btn');

        if (selectedDate === dateStr) {
            selectedDate = null;
            selectedType = "";
            cell.classList.remove('selected');
            
            btn.style.backgroundColor = '#cfd8dc';
            btn.textContent = "è«‹å…ˆé¸æ“‡æ—¥æœŸ";
            btn.style.boxShadow = 'none';
            btn.disabled = true;
        } else {
            document.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
            
            selectedDate = dateStr;
            selectedType = type;
            cell.classList.add('selected');

            btn.disabled = false;
            btn.textContent = "ç¢ºèªé ç´„";
            
            if (themeClass === 'morning') {
                btn.style.backgroundColor = '#ffca28'; 
                btn.style.boxShadow = '0 4px 15px rgba(255, 202, 40, 0.4)';
            } else {
                btn.style.backgroundColor = '#00acc1'; 
                btn.style.boxShadow = '0 4px 15px rgba(0, 172, 193, 0.4)';
            }
        }
    }

    document.getElementById('submit-btn').addEventListener('click', async () => {
        const name = document.getElementById('guest-name').value.trim();
        const phone = document.getElementById('guest-phone').value.trim();
        const email = document.getElementById('guest-email').value.trim();

        if (!name || !phone || !email) {
            alert('è«‹å®Œæ•´å¡«å¯«ï¼šå§“åã€é›»è©±ã€Email');
            return;
        }

        if (!selectedDate) {
            alert('è«‹é»é¸ä¸€å€‹é ç´„æ—¥æœŸ');
            return;
        }

        let timeInfo = selectedType === "morning" ? "æ—©ç­ 06:30" : "æ™šç­ 19:30";
        
        if (!confirm(`ã€é ç´„ç¢ºèªã€‘\n\næ—¥æœŸï¼š${selectedDate}\næ™‚æ®µï¼š${timeInfo}\nå§“åï¼š${name}\né›»è©±ï¼š${phone}\n\nç¢ºèªé€å‡ºï¼Ÿ`)) {
            return;
        }

        const loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = 'flex';
        
        try {
            const params = new URLSearchParams({
                mode: 'trial_submit',
                date: selectedDate,
                name: name,
                phone: phone,
                email: email
            });

            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();

            loadingDiv.style.display = 'none';

            if (result.status === 'success') {
                alert('âœ… é ç´„æˆåŠŸï¼\n\nç³»çµ±å·²ç™¼é€ Google Calendar é‚€è«‹è‡³æ‚¨çš„ Emailã€‚');
                window.location.reload();
            } else {
                alert('âŒ é ç´„å¤±æ•—ï¼š' + result.message);
            }

        } catch (error) {
            console.error(error);
            loadingDiv.style.display = 'none';
            alert('âŒ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
    });

    renderCalendar();
  </script>
</body>
</html>
